<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulation ‚Äî MarketSim Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#111827;--border:#1e293b;--primary:#3b82f6;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#e2e8f0;--muted:#94a3b8;--surface:#1e293b}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
.btn{padding:8px 20px;border-radius:8px;border:none;font-weight:600;font-size:.85rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
.btn-primary:hover{transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary)}
.btn-green{background:var(--green);color:#fff;padding:10px 28px;font-size:.95rem}
.btn-green:hover{opacity:.9}
.btn-sm{padding:6px 14px;font-size:.8rem}
select,input[type=number],input[type=text]{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.85rem;font-family:inherit}
select:focus,input:focus{outline:none;border-color:var(--primary)}

/* Top Bar */
.topbar{display:flex;justify-content:space-between;align-items:center;padding:6px 24px;border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:16px}
.topbar .logo{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.game-info{display:flex;align-items:center;gap:12px;font-size:.85rem;color:var(--muted)}
.game-info .code{background:var(--surface);padding:3px 10px;border-radius:4px;font-family:monospace;color:var(--yellow)}
.quarter-badge{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:4px 14px;border-radius:20px;font-weight:700;font-size:.85rem}
.topbar-right{display:flex;align-items:center;gap:10px}

/* Layout */
.app-layout{display:flex;flex:1;overflow:hidden}

/* Sidebar */
.sidebar{width:220px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-section{padding:4px 0}
.sidebar-label{font-size:.65rem;text-transform:uppercase;color:var(--muted);padding:6px 16px 2px;letter-spacing:.05em;font-weight:600}
.sidebar-item{display:flex;align-items:center;gap:8px;padding:5px 16px;font-size:.82rem;cursor:pointer;transition:all .15s;color:var(--muted);border-left:3px solid transparent}
.sidebar-item:hover{background:rgba(59,130,246,.05);color:var(--text)}
.sidebar-item.active{background:rgba(59,130,246,.08);color:var(--primary);border-left-color:var(--primary);font-weight:600}
.sidebar-divider{height:1px;background:var(--border);margin:4px 0}
.sidebar-footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--border)}

/* Main Content */
.main{flex:1;overflow-y:auto;padding:24px}
.main h2{font-size:1.3rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.tab-content{display:none}.tab-content.active{display:block}

/* Cards & Panels */
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
.panel h3{font-size:1rem;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.panel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.stat-card{background:var(--surface);border-radius:10px;padding:16px}
.stat-label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
.stat-value{font-size:1.4rem;font-weight:700;margin-top:4px}
.stat-value.positive{color:var(--green)}.stat-value.negative{color:var(--red)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;padding:8px 12px;color:var(--muted);font-size:.75rem;text-transform:uppercase;border-bottom:1px solid var(--border);font-weight:600}
td{padding:8px 12px;border-bottom:1px solid rgba(30,41,59,.5)}
tr:hover td{background:rgba(59,130,246,.03)}

/* Brand Builder */
.brand-form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.component-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(30,41,59,.3)}
.component-label{font-size:.85rem;min-width:120px}
.component-slider{display:flex;align-items:center;gap:8px;flex:1}
.component-slider input[type=range]{flex:1;accent-color:var(--primary)}
.component-slider .val{min-width:24px;text-align:center;font-weight:600;color:var(--primary)}

/* Region inputs */
.region-grid{display:grid;grid-template-columns:120px repeat(3,1fr);gap:8px;align-items:center}
.region-grid .header{font-size:.75rem;color:var(--muted);text-transform:uppercase;font-weight:600}

/* Scorecard */
.scorecard-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
.sc-item{background:var(--surface);border-radius:10px;padding:14px 18px;flex:1;min-width:140px;text-align:center}
.sc-item .label{font-size:.7rem;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.sc-item .score{font-size:1.6rem;font-weight:700}
.sc-total .score{background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

/* Leaderboard */
.lb-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border-radius:10px;margin-bottom:8px}
.lb-rank{font-size:1.3rem;font-weight:700;min-width:32px;text-align:center}
.lb-rank.gold{color:#fbbf24}.lb-rank.silver{color:#94a3b8}.lb-rank.bronze{color:#d97706}
.lb-name{flex:1;font-weight:600}.lb-score{font-size:1.1rem;font-weight:700;color:var(--primary)}

/* Submit bar */
.submit-bar{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.submit-bar .status{font-size:.85rem;color:var(--muted)}
.submit-bar .status.submitted{color:var(--green)}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--muted)}

/* Instructor panel */
/* Solo mode only ‚Äî no instructor panel */

@media(max-width:900px){.sidebar{width:60px}.sidebar-item span{display:none}.sidebar-label{display:none}}
/* Paywall modal */
.paywall-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:pwFadeIn .3s ease}
@keyframes pwFadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.advisor-section{margin-bottom:20px;padding:16px;background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.15);border-radius:10px}
.advisor-section h4{margin:0 0 8px;color:#818cf8;font-size:.9rem}
.advisor-section p,.advisor-section li{color:var(--text-secondary);font-size:.88rem;line-height:1.6}
.advisor-section ul{margin:4px 0 0 0;padding-left:18px}
.advisor-section li{margin-bottom:4px}
.advisor-highlight{background:rgba(52,211,153,.08);border-color:rgba(52,211,153,.2)}
.advisor-highlight h4{color:#34d399}
.advisor-warning{background:rgba(248,113,113,.06);border-color:rgba(248,113,113,.15)}
.advisor-warning h4{color:#f87171}
.advisor-meta{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:.75rem;color:var(--muted)}
.paywall-box{background:#fff;border-radius:24px;max-width:460px;width:90%;overflow:hidden;animation:pwSlideUp .3s ease;box-shadow:0 25px 50px rgba(0,0,0,.25)}
@keyframes pwSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.paywall-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:32px;text-align:center}
.paywall-header .pw-icon{font-size:48px;margin-bottom:12px}
.paywall-header h2{font-size:1.6rem;margin:0 0 6px}
.paywall-header p{margin:0;opacity:.9;font-size:.95rem}
.paywall-progress{padding:20px 32px;border-bottom:1px solid #f1f5f9}
.pw-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:10px}
.pw-bar-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:4px}
.pw-labels{display:flex;justify-content:space-between;font-size:.8rem;color:#64748b}
.pw-labels .locked{color:#ef4444}
.paywall-benefits{padding:24px 32px}
.paywall-benefits h3{margin:0 0 14px;color:#1e293b;font-size:1rem}
.paywall-benefits ul{list-style:none;padding:0;margin:0}
.paywall-benefits li{padding:7px 0;color:#475569;font-size:.9rem}
.paywall-benefits li::before{content:'‚úì ';color:#10b981;font-weight:700}
.paywall-pricing{display:flex;gap:12px;padding:0 32px;margin-bottom:8px}
.pw-price-card{flex:1;background:#f8fafc;border-radius:12px;padding:16px;text-align:center;border:2px solid transparent;cursor:pointer;transition:all .2s}
.pw-price-card:hover,.pw-price-card.selected{border-color:#6366f1}
.pw-price-card .pw-amt{font-size:1.8rem;font-weight:800;color:#1e293b}
.pw-price-card .pw-per{font-size:.82rem;color:#64748b}
.pw-price-card .pw-tag{font-size:.7rem;color:#10b981;font-weight:600;margin-top:4px}
.paywall-actions{padding:20px 32px 28px;display:flex;flex-direction:column;gap:10px}
.pw-btn-upgrade{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:14px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit}
.pw-btn-upgrade:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,.4)}
.pw-btn-later{background:none;border:none;color:#64748b;padding:10px;cursor:pointer;font-size:.88rem;font-family:inherit}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <a href="/dashboard.html" class="logo">üéØ MarketSim</a>
    <div class="game-info">
      <span id="gameName">Loading...</span>
      <span class="quarter-badge" id="quarterBadge">Q0</span>
    </div>
  </div>
  <div class="topbar-right">
    <span id="teamName" style="font-size:.85rem;color:var(--muted)"></span>
    <span id="cashDisplay" style="font-size:.85rem;font-weight:600;color:var(--green)"></span>
    <button class="btn btn-outline btn-sm" onclick="window.location.href='/dashboard.html'">‚Üê Dashboard</button>
  </div>
</div>

<div class="app-layout">
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Decisions</div>
      <div class="sidebar-item active" data-tab="overview"><span>üìä</span><span>Overview</span></div>
      <div class="sidebar-item" data-tab="brands"><span>üè∑Ô∏è</span><span>Brands</span></div>
      <div class="sidebar-item" data-tab="pricing"><span>üí≤</span><span>Pricing</span></div>
      <div class="sidebar-item" data-tab="advertising"><span>üì£</span><span>Advertising</span></div>
      <div class="sidebar-item" data-tab="salesforce"><span>üë•</span><span>Sales Force</span></div>
      <div class="sidebar-item" data-tab="distribution"><span>üè™</span><span>Distribution</span></div>
      <div class="sidebar-item" data-tab="production"><span>üè≠</span><span>Production</span></div>
      <div class="sidebar-item" data-tab="rd"><span>üî¨</span><span>R&D</span></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-label" id="reportsToggle" onclick="toggleReports()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none">
        <span>Reports</span><span id="reportsArrow" style="font-size:.6rem;transition:transform .2s">‚ñº</span>
      </div>
      <div id="reportsMenu" style="display:none">
        <div class="sidebar-item" data-tab="results"><span>üìà</span><span>Results</span></div>
        <div class="sidebar-item" data-tab="financials"><span>üí∞</span><span>Financials</span></div>
        <div class="sidebar-item" data-tab="research"><span>üîç</span><span>Market Research</span></div>
        <div class="sidebar-item" data-tab="leaderboard"><span>üèÜ</span><span>Rankings vs AI</span></div>
        <div class="sidebar-item" data-tab="advisor"><span>üß†</span><span>AI Advisor</span></div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn btn-green" style="width:100%" onclick="submitDecisions()" id="submitBtn">Submit Q<span id="submitQ">1</span></button>
    </div>
  </div>

  <div class="main" id="mainContent">

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <h2>üìä Quarter Overview</h2>
      <div class="panel-grid" id="overviewStats">
        <div class="stat-card"><div class="stat-label">Cash Balance</div><div class="stat-value" id="ovCash">$5,000,000</div></div>
        <div class="stat-card"><div class="stat-label">Revenue (Last Q)</div><div class="stat-value" id="ovRevenue">$0</div></div>
        <div class="stat-card"><div class="stat-label">Net Income (Last Q)</div><div class="stat-value" id="ovIncome">$0</div></div>
        <div class="stat-card"><div class="stat-label">Market Share</div><div class="stat-value" id="ovShare">0%</div></div>
        <div class="stat-card"><div class="stat-label">Total Demand</div><div class="stat-value" id="ovDemand">0</div></div>
        <div class="stat-card"><div class="stat-label">Balanced Scorecard</div><div class="stat-value" id="ovBSC">0.0</div></div>
      </div>
      <div class="panel" id="overviewTips">
        <h3>üí° Getting Started</h3>
        <p style="color:var(--muted);font-size:.9rem;line-height:1.6" id="tipText">Start by designing your first brand in the Brands tab. Then set pricing, plan your advertising, hire sales staff, and set up distribution. When ready, click Submit to lock in your decisions for this quarter.</p>
      </div>
    </div>

    <!-- BRANDS TAB -->
    <div class="tab-content" id="tab-brands">
      <h2>üè∑Ô∏è Brand Management</h2>
      <div class="panel">
        <h3>Design a New Brand</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div><label style="font-size:.8rem;color:var(--muted)">Brand Name</label><input type="text" id="brandName" placeholder="e.g. Nova X1" style="width:100%;margin-top:4px"></div>
          <div><label style="font-size:.8rem;color:var(--muted)">Target Segment</label><select id="brandSegment" style="width:100%;margin-top:4px"><option value="Worker">Worker</option><option value="Recreation">Recreation</option><option value="Youth">Youth</option><option value="Mountain">Mountain</option><option value="Speed">Speed</option></select></div>
        </div>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Set component quality (0=None, 1=Basic, 5=Premium). Higher quality increases cost but improves brand appeal.</p>
        <div id="componentSliders"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
          <div><span style="font-size:.85rem;color:var(--muted)">Est. Unit Cost: </span><strong id="estCost">$0</strong></div>
          <button class="btn btn-primary" onclick="createBrand()">Create Brand</button>
        </div>
      </div>
      <div class="panel">
        <h3>Active Brands</h3>
        <div id="brandList"><p style="color:var(--muted);font-size:.85rem">No brands yet. Design your first brand above.</p></div>
      </div>
    </div>

    <!-- PRICING TAB -->
    <div class="tab-content" id="tab-pricing">
      <h2>üí≤ Pricing Strategy</h2>
      <div class="panel">
        <h3>Set Prices Per Brand</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Prices are per unit in USD. Consider segment price sensitivity and competitor pricing.</p>
        <div id="pricingTable"><p style="color:var(--muted);font-size:.85rem">Create brands first to set pricing.</p></div>
      </div>
    </div>

    <!-- ADVERTISING TAB -->
    <div class="tab-content" id="tab-advertising">
      <h2>üì£ Advertising & Marketing</h2>
      <div class="panel">
        <h3>Media Spend</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Allocate quarterly advertising budget per region (in $). Target specific segments with your ads.</p>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Ad Budget</div>
          <input type="number" id="ad_latam" value="0" min="0" step="10000" onchange="updateDecisions()">
          <input type="number" id="ad_europe" value="0" min="0" step="10000" onchange="updateDecisions()">
          <input type="number" id="ad_apac" value="0" min="0" step="10000" onchange="updateDecisions()">
        </div>
        <div style="margin-top:12px">
          <label style="font-size:.8rem;color:var(--muted)">Primary Ad Target Segment</label>
          <select id="adTarget" style="margin-top:4px" onchange="updateDecisions()"><option value="Worker">Worker</option><option value="Recreation">Recreation</option><option value="Youth">Youth</option><option value="Mountain">Mountain</option><option value="Speed">Speed</option></select>
        </div>
      </div>
      <div class="panel">
        <h3>Internet Marketing</h3>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>SEM Budget</div>
          <input type="number" id="sem_latam" value="0" min="0" step="5000" onchange="updateDecisions()">
          <input type="number" id="sem_europe" value="0" min="0" step="5000" onchange="updateDecisions()">
          <input type="number" id="sem_apac" value="0" min="0" step="5000" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- SALES FORCE TAB -->
    <div class="tab-content" id="tab-salesforce">
      <h2>üë• Sales Force Management</h2>
      <div class="panel">
        <h3>Sales Team</h3>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Sales Reps</div>
          <input type="number" id="sf_latam" value="2" min="0" max="50" onchange="updateDecisions()">
          <input type="number" id="sf_europe" value="2" min="0" max="50" onchange="updateDecisions()">
          <input type="number" id="sf_apac" value="1" min="0" max="50" onchange="updateDecisions()">
          <div>Salary ($)</div>
          <input type="number" id="sfsal_latam" value="40000" min="20000" step="5000" onchange="updateDecisions()">
          <input type="number" id="sfsal_europe" value="50000" min="20000" step="5000" onchange="updateDecisions()">
          <input type="number" id="sfsal_apac" value="35000" min="20000" step="5000" onchange="updateDecisions()">
          <div>Commission %</div>
          <input type="number" id="sfcom_latam" value="5" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="sfcom_europe" value="5" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="sfcom_apac" value="5" min="0" max="20" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- DISTRIBUTION TAB -->
    <div class="tab-content" id="tab-distribution">
      <h2>üè™ Distribution Channels</h2>
      <div class="panel">
        <h3>Sales Outlets</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Each outlet costs ~$50,000/quarter to operate. More outlets = wider reach.</p>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Outlets</div>
          <input type="number" id="dist_latam" value="1" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="dist_europe" value="1" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="dist_apac" value="0" min="0" max="20" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- PRODUCTION TAB -->
    <div class="tab-content" id="tab-production">
      <h2>üè≠ Production Planning</h2>
      <div class="panel">
        <h3>Units to Produce Per Brand</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Set production quantity for each active brand. Overproduction wastes money; underproduction means lost sales (stockouts).</p>
        <div id="productionTable"><p style="color:var(--muted);font-size:.85rem">Create brands first to plan production.</p></div>
      </div>
    </div>

    <!-- R&D TAB -->
    <div class="tab-content" id="tab-rd">
      <h2>üî¨ Research & Development</h2>
      <div class="panel">
        <h3>R&D Investment</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Invest in R&D to unlock new component improvements. Typical investment: $200K-$1M per quarter.</p>
        <div style="display:flex;gap:12px;align-items:end">
          <div style="flex:1"><label style="font-size:.8rem;color:var(--muted)">R&D Budget This Quarter ($)</label><input type="number" id="rdBudget" value="250000" min="0" step="50000" style="width:100%;margin-top:4px" onchange="updateDecisions()"></div>
        </div>
        <div style="margin-top:12px"><label style="font-size:.8rem;color:var(--muted)">Cumulative R&D Investment:</label> <strong id="rdCumulative">$0</strong></div>
      </div>
      <div class="panel">
        <h3>Dividend to Corporate</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Optional: Return profits to corporate HQ.</p>
        <input type="number" id="dividend" value="0" min="0" step="50000" onchange="updateDecisions()">
      </div>
    </div>

    <!-- RESULTS TAB -->
    <div class="tab-content" id="tab-results">
      <h2>üìà Quarterly Results</h2>
      <div id="resultsContent"><p style="color:var(--muted)">Results will appear after the first quarter is processed.</p></div>
    </div>

    <!-- FINANCIALS TAB -->
    <div class="tab-content" id="tab-financials">
      <h2>üí∞ Financial Statements</h2>
      <div id="financialsContent"><p style="color:var(--muted)">Financial data will appear after the first quarter is processed.</p></div>
    </div>

    <!-- MARKET RESEARCH TAB -->
    <div class="tab-content" id="tab-research">
      <h2>üîç Market Research</h2>
      <div id="researchContent"><p style="color:var(--muted)">Market research data will be available after the first quarter.</p></div>
    </div>

    <!-- LEADERBOARD TAB -->
    <div class="tab-content" id="tab-leaderboard">
      <h2>üèÜ Rankings vs AI Competitors</h2>
      <div id="leaderboardContent"><p style="color:var(--muted)">Rankings will appear after your first quarter is processed.</p></div>
    </div>

    <!-- AI ADVISOR TAB -->
    <div class="tab-content" id="tab-advisor">
      <h2>üß† AI Strategy Advisor</h2>
      <div class="panel" id="advisorPanel">
        <div style="text-align:center;padding:20px" id="advisorEmpty">
          <div style="font-size:3rem;margin-bottom:12px">üß†</div>
          <h3 style="margin:0 0 8px">Your Personal Strategy Advisor</h3>
          <p style="color:var(--muted);font-size:.9rem;margin:0 0 20px;max-width:450px;margin-left:auto;margin-right:auto">Get AI-powered analysis of your performance, competitive position, and actionable recommendations for your next quarter.</p>
          <button class="btn btn-primary" onclick="getAdvisorAnalysis()" id="advisorBtn" style="font-size:1rem;padding:10px 28px">üìä Analyze My Performance</button>
        </div>
        <div id="advisorContent" style="display:none"></div>
        <div id="advisorLoading" style="display:none;text-align:center;padding:40px">
          <div style="font-size:2rem;margin-bottom:12px;animation:pulse 1.5s infinite">üß†</div>
          <p style="color:var(--muted)">Analyzing your strategy and market position...</p>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="submit-bar">
  <div class="status" id="submitStatus">Editing decisions...</div>
  <div style="display:flex;gap:12px;align-items:center">
    <button class="btn btn-outline btn-sm" onclick="saveDecisions()">üíæ Save Draft</button>
    <button class="btn btn-green" onclick="submitDecisions()">‚úÖ Submit Quarter</button>
  </div>
</div>

<script>
const API=window.location.origin;
const gameId=new URLSearchParams(location.search).get('game');
let user=null,game=null,team=null,brands=[],decisions={},results=null;

const COMPONENTS=['frame','wheels','drivetrain','brakes','suspension','seat','handlebars','electronics'];

// Product-specific component labels per scenario
const PRODUCT_LABELS={
  'local-launch':{
    frame:'üèóÔ∏è Build Quality', wheels:'üì± Display', drivetrain:'‚ö° Processor', brakes:'üîã Battery',
    suspension:'üì∏ Camera', seat:'üñ•Ô∏è Software', handlebars:'üíæ Storage', electronics:'üì° Connectivity',
    productName:'Smartphone',
    segments:{Worker:'Budget Buyers',Recreation:'Social Connectors'}
  },
  'mountain-expedition':{
    frame:'üõ°Ô∏è Case Design', wheels:'üì± Display', drivetrain:'‚ù§Ô∏è Sensors', brakes:'üîã Battery Life',
    suspension:'üí™ Durability', seat:'ü§≤ Comfort & Fit', handlebars:'‚ú® Style & Design', electronics:'üì° Connectivity',
    productName:'Wearable',
    segments:{Mountain:'Athletes',Recreation:'Health-Conscious',Speed:'Tech Enthusiasts'}
  },
  'global-domination':{
    frame:'üèóÔ∏è Build Quality', wheels:'üñ•Ô∏è Display', drivetrain:'‚ö° Processor', brakes:'üîã Battery',
    suspension:'üéÆ Graphics Card', seat:'‚å®Ô∏è Keyboard', handlebars:'üíæ Storage', electronics:'üì° Connectivity',
    productName:'Laptop',
    segments:{Worker:'Business Pros',Recreation:'Students',Youth:'Casual Users',Mountain:'Creative Pros',Speed:'Gamers'}
  },
  'speed-innovation':{
    frame:'üõ°Ô∏è Build Quality', wheels:'üëÅÔ∏è Display / Optics', drivetrain:'‚ö° Processor', brakes:'üéØ Motion Tracking',
    suspension:'üîä Audio System', seat:'ü§≤ Comfort', handlebars:'üéÆ Software / Content', electronics:'üì° Connectivity',
    productName:'VR Headset',
    segments:{Speed:'Hardcore Gamers',Youth:'Casual Gamers'}
  }
};

// Fallback labels
const DEFAULT_LABELS={frame:'üèóÔ∏è Component 1',wheels:'üîµ Component 2',drivetrain:'‚öôÔ∏è Component 3',brakes:'üõë Component 4',suspension:'üîß Component 5',seat:'üí∫ Component 6',handlebars:'üéØ Component 7',electronics:'üí° Component 8',productName:'Product',segments:{Worker:'Worker',Recreation:'Recreation',Youth:'Youth',Mountain:'Mountain',Speed:'Speed'}};

function getComponentLabels(scenario){return PRODUCT_LABELS[scenario]||DEFAULT_LABELS;}
let COMPONENT_LABELS=DEFAULT_LABELS;
const REGIONS=['LATAM','Europe','APAC'];

// Scenario-specific active regions and suggested starting values
const SCENARIO_CONFIG={
  'local-launch':{regions:['LATAM'],suggestedPrice:799,suggestedProd:1000,suggestedAd:100000,suggestedReps:5,suggestedDist:50000,suggestedRD:100000},
  'mountain-expedition':{regions:['Europe'],suggestedPrice:999,suggestedProd:800,suggestedAd:150000,suggestedReps:6,suggestedDist:75000,suggestedRD:150000},
  'global-domination':{regions:['LATAM','Europe','APAC'],suggestedPrice:1099,suggestedProd:600,suggestedAd:200000,suggestedReps:4,suggestedDist:80000,suggestedRD:200000},
  'speed-innovation':{regions:['APAC'],suggestedPrice:1299,suggestedProd:500,suggestedAd:200000,suggestedReps:5,suggestedDist:100000,suggestedRD:250000}
};
let ACTIVE_REGIONS=REGIONS;
let SUGGESTED={price:899,prod:1000,ad:100000,reps:5,dist:50000,rd:100000};

async function apiFetch(url,opts={}){
  const token=localStorage.getItem('token');
  const headers={'Content-Type':'application/json'};
  if(token)headers['Authorization']='Bearer '+token;
  try{
    const res=await fetch(API+url,{...opts,headers});
    const text=await res.text();
    try{return JSON.parse(text)}catch(e){console.error('Non-JSON from '+url+':',text);return{error:'Server error'}}
  }catch(e){console.error('Network error for '+url+':',e);return{error:'Network error'}}
}

// Init component sliders
function initSliders(){
  const container=document.getElementById('componentSliders');
  container.innerHTML=COMPONENTS.map(c=>`
    <div class="component-row">
      <div class="component-label">${COMPONENT_LABELS[c]}</div>
      <div class="component-slider">
        <span style="font-size:.65rem;color:var(--muted);min-width:12px">0</span>
        <input type="range" min="0" max="5" value="3" id="comp_${c}" oninput="document.getElementById('compval_${c}').textContent=this.value;updateEstCost()">
        <span style="font-size:.65rem;color:var(--muted);min-width:12px">5</span>
        <div class="val" id="compval_${c}">3</div>
      </div>
    </div>
  `).join('');
  container.insertAdjacentHTML('beforeend','<p style="font-size:.7rem;color:var(--muted);margin-top:6px">0=None ¬∑ 1=Basic ¬∑ 2=Budget ¬∑ 3=Standard ¬∑ 4=Premium ¬∑ 5=Ultra</p>');
}

function updateEstCost(){
  let cost=50;
  COMPONENTS.forEach(c=>{const v=parseInt(document.getElementById('comp_'+c).value);cost+=v*v*8+v*15});
  document.getElementById('estCost').textContent='$'+cost.toLocaleString();
}

// Tab navigation
function toggleReports(){
  const menu=document.getElementById('reportsMenu');
  const arrow=document.getElementById('reportsArrow');
  if(menu.style.display==='none'){
    menu.style.display='block';
    arrow.style.transform='rotate(180deg)';
  }else{
    menu.style.display='none';
    arrow.style.transform='rotate(0deg)';
  }
}

document.querySelectorAll('.sidebar-item').forEach(item=>{
  item.addEventListener('click',()=>{
    document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+item.dataset.tab).classList.add('active');
    // Auto-expand reports if a report tab is activated
    const reportTabs=['results','financials','research','leaderboard','advisor'];
    if(reportTabs.includes(item.dataset.tab)){
      document.getElementById('reportsMenu').style.display='block';
      document.getElementById('reportsArrow').style.transform='rotate(180deg)';
    }
  });
});

async function init(){
  if(!gameId)return window.location.href='/dashboard.html';
  const authData=await apiFetch('/api/auth/me');
  if(!authData.user)return window.location.href='/index.html';
  user=authData.user;

  const gameData=await apiFetch('/api/game/details?game_id='+gameId);
  if(gameData.error)return alert(gameData.error);
  game=gameData.game;
  team=gameData.team;
  brands=(gameData.brands||[]).map(b=>{b.is_active=b.is_active!==undefined?b.is_active:true;return b});
  // Set product-specific component labels based on scenario
  COMPONENT_LABELS=getComponentLabels(game.market_scenario);
  // Set scenario-specific regions and defaults
  const scenCfg=SCENARIO_CONFIG[game.market_scenario];
  if(scenCfg){
    ACTIVE_REGIONS=scenCfg.regions;
    SUGGESTED={price:scenCfg.suggestedPrice,prod:scenCfg.suggestedProd,ad:scenCfg.suggestedAd,reps:scenCfg.suggestedReps,dist:scenCfg.suggestedDist,rd:scenCfg.suggestedRD};
  }
  // Update segment dropdowns with product-specific names
  const segLabels=COMPONENT_LABELS.segments||{};
  ['brandSegment','adTarget'].forEach(id=>{
    const sel=document.getElementById(id);
    if(!sel)return;
    sel.innerHTML='';
    Object.keys(segLabels).forEach(key=>{
      const opt=document.createElement('option');
      opt.value=key;
      opt.textContent=segLabels[key];
      sel.appendChild(opt);
    });
  });

  document.getElementById('gameName').textContent=game.name||'Simulation';
  document.getElementById('quarterBadge').textContent=game.status==='completed'?'Complete':'Q'+game.current_quarter;
  if(game.status==='completed')document.getElementById('quarterBadge').style.background='#10b981';
  document.getElementById('submitQ').textContent=game.current_quarter||1;
  if(team){
    document.getElementById('teamName').textContent=(team.logo_emoji||'üè¢')+' '+(team.name||'My Company');
    document.getElementById('cashDisplay').textContent='$'+Number(team.cash_balance||5000000).toLocaleString();
  }

  // Instructor panel removed ‚Äî using preset scenarios only

  initSliders();
  updateEstCost();
  await loadDecisions();
  loadBrandList();
  setupScenarioDefaults();
  loadResults();
  loadLeaderboard();
  loadResearch();

  // Auto-expand reports section when results are available
  if(game.current_quarter>=2){
    document.getElementById('reportsMenu').style.display='block';
    document.getElementById('reportsArrow').style.transform='rotate(180deg)';
  }

  // If game is completed, show the final summary screen
  if(game.status==='completed'){
    showGameSummary();
  }
}

async function showGameSummary(){
  // Hide the sidebar submit button and decision tabs
  const submitBtn=document.getElementById('submitBtn');
  if(submitBtn)submitBtn.style.display='none';

  // Fetch all quarterly results
  const allData=await apiFetch(`/api/simulation/get-results?game_id=${gameId}&team_id=${team.id}`);
  const history=(allData.results||[]).sort((a,b)=>a.quarter-b.quarter);

  // Fetch leaderboard
  const lbData=await apiFetch(`/api/simulation/leaderboard?game_id=${gameId}`);
  const leaderboard=lbData.leaderboard||[];

  // Find player rank
  let playerRank=1,playerTeamData=null;
  leaderboard.forEach((t,i)=>{if(t.isPlayer){playerRank=i+1;playerTeamData=t;}});

  // Calculate cumulative stats
  const totalRevenue=history.reduce((s,r)=>s+(r.revenue||0),0);
  const totalProfit=history.reduce((s,r)=>s+(r.netIncome||0),0);
  const totalUnitsSold=history.reduce((s,r)=>s+(r.unitsSold||0),0);
  const endingCash=history.length>0?history[history.length-1].endingCash:0;
  const bestQuarter=history.reduce((best,r)=>(!best||r.revenue>best.revenue)?r:best,null);
  const worstQuarter=history.reduce((worst,r)=>(!worst||r.netIncome<worst.netIncome)?r:worst,null);
  const avgScorecard=history.length>0?(history.reduce((s,r)=>s+(r.scorecard?.balanced||0),0)/history.length):0;
  const peakMarketShare=Math.max(...history.map(r=>r.marketShare||0));

  // Rank label
  const rankEmoji=playerRank===1?'ü•á':playerRank===2?'ü•à':playerRank===3?'ü•â':'üèÖ';
  const rankLabel=playerRank===1?'Champion':playerRank===2?'Runner-Up':playerRank===3?'Third Place':'Participant';

  // Build sparkline data for mini charts
  const revData=history.map(r=>r.revenue||0);
  const shareData=history.map(r=>(r.marketShare||0)*100);
  const scoreData=history.map(r=>r.scorecard?.balanced||0);
  const cashData=history.map(r=>r.endingCash||0);

  function miniChart(data,color,height){
    if(!data.length)return '';
    const max=Math.max(...data,1);const min=Math.min(...data,0);
    const range=max-min||1;const w=200;const h=height||40;
    const points=data.map((v,i)=>`${(i/(data.length-1))*w},${h-((v-min)/range)*h}`).join(' ');
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="display:block"><polyline points="${points}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  }

  // Replace main content with summary
  const mainContent=document.getElementById('mainContent');
  mainContent.innerHTML=`
    <div style="max-width:900px;margin:0 auto;padding:20px 0">
      
      <!-- Hero Banner -->
      <div style="text-align:center;padding:40px 20px;background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(139,92,246,.1));border-radius:16px;border:1px solid rgba(99,102,241,.15);margin-bottom:24px">
        <div style="font-size:3rem;margin-bottom:8px">${rankEmoji}</div>
        <h1 style="margin:0 0 4px;font-size:1.8rem;color:var(--text)">Simulation Complete!</h1>
        <p style="margin:0 0 16px;color:var(--muted);font-size:1rem">${game.name||'MarketSim'} ‚Äî 8 Quarters</p>
        <div style="display:inline-block;background:${playerRank===1?'rgba(52,211,153,.15)':playerRank===2?'rgba(59,130,246,.15)':'rgba(251,191,36,.15)'};padding:8px 24px;border-radius:99px;font-size:1.1rem;font-weight:700;color:${playerRank===1?'#34d399':playerRank===2?'#60a5fa':'#fbbf24'}">
          ${rankLabel} ‚Äî #${playerRank} of ${leaderboard.length}
        </div>
      </div>

      <!-- Key Metrics Grid -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
        <div class="panel" style="text-align:center;padding:16px">
          <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Total Revenue</div>
          <div style="font-size:1.4rem;font-weight:700;color:var(--green);margin:4px 0">$${Number(totalRevenue).toLocaleString()}</div>
          ${miniChart(revData,'#34d399',30)}
        </div>
        <div class="panel" style="text-align:center;padding:16px">
          <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Total Profit</div>
          <div style="font-size:1.4rem;font-weight:700;color:${totalProfit>=0?'var(--green)':'var(--red)'};margin:4px 0">$${Number(totalProfit).toLocaleString()}</div>
          <div style="font-size:.75rem;color:var(--muted)">Ending Cash: $${Number(endingCash).toLocaleString()}</div>
        </div>
        <div class="panel" style="text-align:center;padding:16px">
          <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Peak Market Share</div>
          <div style="font-size:1.4rem;font-weight:700;color:#60a5fa;margin:4px 0">${peakMarketShare.toFixed(1)}%</div>
          ${miniChart(shareData,'#60a5fa',30)}
        </div>
        <div class="panel" style="text-align:center;padding:16px">
          <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Avg Scorecard</div>
          <div style="font-size:1.4rem;font-weight:700;color:#a78bfa;margin:4px 0">${avgScorecard.toFixed(2)}</div>
          ${miniChart(scoreData,'#a78bfa',30)}
        </div>
      </div>

      <!-- Quarterly Performance Table -->
      <div class="panel" style="margin-bottom:24px">
        <h3 style="margin:0 0 12px">üìà Quarter-by-Quarter Performance</h3>
        <div style="overflow-x:auto">
          <table style="width:100%">
            <thead><tr>
              <th>Quarter</th><th style="text-align:right">Revenue</th><th style="text-align:right">Net Income</th>
              <th style="text-align:right">Units</th><th style="text-align:right">Market Share</th>
              <th style="text-align:right">Cash</th><th style="text-align:right">Scorecard</th>
            </tr></thead>
            <tbody>
              ${history.map(r=>`<tr>
                <td><strong>Q${r.quarter}</strong></td>
                <td style="text-align:right">$${Number(r.revenue||0).toLocaleString()}</td>
                <td style="text-align:right;color:${(r.netIncome||0)>=0?'var(--green)':'var(--red)'}">$${Number(r.netIncome||0).toLocaleString()}</td>
                <td style="text-align:right">${Number(r.unitsSold||0).toLocaleString()}</td>
                <td style="text-align:right">${((r.marketShare||0)*100).toFixed(1)}%</td>
                <td style="text-align:right">$${Number(r.endingCash||0).toLocaleString()}</td>
                <td style="text-align:right;font-weight:600">${(r.scorecard?.balanced||0).toFixed(2)}</td>
              </tr>`).join('')}
            </tbody>
            <tfoot><tr style="font-weight:700;border-top:2px solid var(--border)">
              <td>TOTAL</td>
              <td style="text-align:right">$${Number(totalRevenue).toLocaleString()}</td>
              <td style="text-align:right;color:${totalProfit>=0?'var(--green)':'var(--red)'}">$${Number(totalProfit).toLocaleString()}</td>
              <td style="text-align:right">${Number(totalUnitsSold).toLocaleString()}</td>
              <td style="text-align:right">${peakMarketShare.toFixed(1)}% peak</td>
              <td style="text-align:right">$${Number(endingCash).toLocaleString()}</td>
              <td style="text-align:right">${avgScorecard.toFixed(2)} avg</td>
            </tr></tfoot>
          </table>
        </div>
      </div>

      <!-- Final Leaderboard -->
      <div class="panel" style="margin-bottom:24px">
        <h3 style="margin:0 0 12px">üèÜ Final Standings</h3>
        ${leaderboard.map((t,i)=>{
          const isYou=t.isPlayer;
          const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
          return `<div style="display:flex;align-items:center;padding:12px 16px;margin-bottom:8px;border-radius:10px;${isYou?'background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25)':'background:rgba(255,255,255,.02);border:1px solid var(--border)'}">
            <div style="font-size:1.2rem;font-weight:700;width:40px;color:${i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#cd7f32':'var(--muted)'}">#${i+1}</div>
            <div style="flex:1">
              <div style="font-weight:600">${medal} ${esc(t.name)} ${isYou?'<span style="color:var(--primary);font-size:.75rem;font-weight:400">YOU</span>':'<span style="color:var(--muted);font-size:.75rem">ü§ñ AI</span>'}</div>
              <div style="font-size:.75rem;color:var(--muted);margin-top:2px">Revenue: $${Number(t.totalRevenue||0).toLocaleString()} ¬∑ Profit: $${Number(t.totalProfit||0).toLocaleString()}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:1.2rem;font-weight:700;color:${i===0?'#fbbf24':'var(--text)'}">${parseFloat(t.cumulative_scorecard||0).toFixed(2)}</div>
              <div style="font-size:.7rem;color:var(--muted)">scorecard</div>
            </div>
          </div>`;
        }).join('')}
      </div>

      <!-- Highlights -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">
        <div class="panel" style="padding:16px">
          <h4 style="margin:0 0 8px;font-size:.85rem;color:var(--green)">üìà Best Quarter</h4>
          ${bestQuarter?`<div style="font-size:1.1rem;font-weight:700">Q${bestQuarter.quarter}</div>
          <div style="font-size:.8rem;color:var(--muted)">Revenue: $${Number(bestQuarter.revenue||0).toLocaleString()} ¬∑ ${Number(bestQuarter.unitsSold||0).toLocaleString()} units ¬∑ ${((bestQuarter.marketShare||0)*100).toFixed(1)}% share</div>`:'<div style="color:var(--muted)">N/A</div>'}
        </div>
        <div class="panel" style="padding:16px">
          <h4 style="margin:0 0 8px;font-size:.85rem;color:var(--red)">üìâ Toughest Quarter</h4>
          ${worstQuarter?`<div style="font-size:1.1rem;font-weight:700">Q${worstQuarter.quarter}</div>
          <div style="font-size:.8rem;color:var(--muted)">Net Income: $${Number(worstQuarter.netIncome||0).toLocaleString()} ¬∑ $${Number(worstQuarter.revenue||0).toLocaleString()} revenue</div>`:'<div style="color:var(--muted)">N/A</div>'}
        </div>
      </div>

      <!-- AI Final Analysis -->
      <div class="panel" style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <span style="font-size:1.3rem;animation:pulse 1.5s infinite">üß†</span>
          <h3 style="margin:0">AI Coach ‚Äî Final Assessment</h3>
        </div>
        <div id="finalAnalysis">
          <p style="color:var(--muted);font-size:.85rem">Generating your personalized game analysis...</p>
        </div>
      </div>

      <!-- Actions -->
      <div style="display:flex;gap:12px;justify-content:center;padding:20px 0">
        <button class="btn btn-green" onclick="window.location.href='/dashboard.html'" style="padding:12px 32px;font-size:1rem">üè† Back to Dashboard</button>
        <button class="btn btn-outline" onclick="window.print()" style="padding:12px 24px;font-size:1rem">üñ®Ô∏è Print Report</button>
      </div>

    </div>
  `;

  // Hide sidebar decision items, keep reports visible
  document.querySelectorAll('.sidebar-item[data-tab]').forEach(item=>{
    const reportTabs=['results','financials','research','leaderboard','advisor'];
    if(!reportTabs.includes(item.dataset.tab)){
      item.style.opacity='0.4';
      item.style.pointerEvents='none';
    }
  });

  // Generate AI final analysis
  generateFinalAnalysis(history,leaderboard,playerRank);
}

async function generateFinalAnalysis(history,leaderboard,playerRank){
  const totalRevenue=history.reduce((s,r)=>s+(r.revenue||0),0);
  const totalProfit=history.reduce((s,r)=>s+(r.netIncome||0),0);
  const totalUnits=history.reduce((s,r)=>s+(r.unitsSold||0),0);
  const avgScore=history.length>0?(history.reduce((s,r)=>s+(r.scorecard?.balanced||0),0)/history.length):0;

  const revTrend=history.map(h=>'Q'+h.quarter+':$'+Number(h.revenue||0).toLocaleString()).join(' ‚Üí ');
  const shareTrend=history.map(h=>'Q'+h.quarter+':'+((h.marketShare||0)*100).toFixed(0)+'%').join(' ‚Üí ');
  const scoreTrend=history.map(h=>'Q'+h.quarter+':'+(h.scorecard?.balanced||0).toFixed(1)).join(' ‚Üí ');

  const rankInfo=leaderboard.map((t,i)=>'#'+(i+1)+' '+t.name+(t.isPlayer?' (PLAYER)':' (AI)')+': score='+parseFloat(t.cumulative_scorecard||0).toFixed(2)+', rev=$'+Number(t.totalRevenue||0).toLocaleString()+', profit=$'+Number(t.totalProfit||0).toLocaleString()).join('\n');

  const prompt=`You are a sharp, experienced marketing professor giving a final game debrief to a student who just completed an 8-quarter marketing simulation. Be insightful, specific, and educational.

FINAL RESULTS:
- Final Rank: #${playerRank} of ${leaderboard.length}
- Total Revenue: $${totalRevenue.toLocaleString()} | Total Profit: $${totalProfit.toLocaleString()} | Total Units: ${totalUnits.toLocaleString()}
- Average Scorecard: ${avgScore.toFixed(2)}/100
- Brands: ${brands.map(b=>b.name+' targeting '+b.target_segment).join('; ')}

QUARTERLY TRENDS:
Revenue: ${revTrend}
Market Share: ${shareTrend}
Scorecard: ${scoreTrend}

FINAL STANDINGS:
${rankInfo}

Write a comprehensive but concise final assessment in exactly this format:

OVERALL GRADE
Give a letter grade (A+ to F) with a one-sentence justification based on ranking, profitability, and strategic consistency.

WHAT WENT WELL
2-3 specific strengths demonstrated during the simulation. Reference actual quarters and numbers where performance was strong.

WHAT COULD IMPROVE
2-3 specific areas for improvement. Be constructive and reference data showing where things went wrong or opportunities were missed.

KEY TAKEAWAY
One powerful marketing lesson this simulation demonstrated. This should be a genuine insight about marketing strategy, pricing, or competitive dynamics ‚Äî not generic advice.

FINAL SCORE BREAKDOWN
A brief note on what drove the scorecard ‚Äî which components (financial, market, marketing effectiveness, investment, wealth) were strongest and weakest.

Keep total response under 300 words. Be specific with numbers. Sound like a respected professor, not a chatbot.`;

  try{
    const response=await apiFetch('/api/ai/advisor',{method:'POST',body:JSON.stringify({prompt,max_tokens:800})});
    if(response.error)throw new Error(response.error);
    const text=response.text||'';

    // Parse sections
    let html='';
    const sections=text.split(/^(OVERALL GRADE|WHAT WENT WELL|WHAT COULD IMPROVE|KEY TAKEAWAY|FINAL SCORE BREAKDOWN)\s*$/gm);
    const sectionStyles={
      'OVERALL GRADE':{icon:'üéì',bg:'rgba(139,92,246,.06)',border:'1px solid rgba(139,92,246,.15)'},
      'WHAT WENT WELL':{icon:'‚úÖ',bg:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)'},
      'WHAT COULD IMPROVE':{icon:'üîß',bg:'rgba(251,191,36,.06)',border:'1px solid rgba(251,191,36,.12)'},
      'KEY TAKEAWAY':{icon:'üí°',bg:'rgba(59,130,246,.06)',border:'1px solid rgba(59,130,246,.12)'},
      'FINAL SCORE BREAKDOWN':{icon:'üìä',bg:'rgba(99,102,241,.06)',border:'1px solid rgba(99,102,241,.12)'}
    };

    for(let i=1;i<sections.length;i+=2){
      const title=sections[i].trim();
      const body=(sections[i+1]||'').trim();
      if(!body)continue;
      const s=sectionStyles[title]||{icon:'üìã',bg:'transparent',border:'none'};
      const bodyHtml=body.split('\n').filter(l=>l.trim()).map(l=>{
        if(l.trim().match(/^[-‚Ä¢\d]/)){
          return '<div style="padding:2px 0 2px 12px;font-size:.88rem;line-height:1.5;color:var(--text-secondary)">'+esc(l)+'</div>';
        }
        return '<p style="margin:0 0 6px;font-size:.88rem;line-height:1.5;color:var(--text-secondary)">'+esc(l)+'</p>';
      }).join('');
      html+=`<div style="background:${s.bg};border:${s.border};border-radius:10px;padding:14px;margin-bottom:10px">
        <div style="font-weight:600;font-size:.8rem;color:var(--text);margin-bottom:6px">${s.icon} ${title}</div>
        ${bodyHtml}
      </div>`;
    }

    if(!html)html='<p style="font-size:.88rem;line-height:1.6;color:var(--text-secondary)">'+esc(text).replace(/\n/g,'<br>')+'</p>';
    document.getElementById('finalAnalysis').innerHTML=html;
  }catch(e){
    console.error('Final analysis error:',e);
    document.getElementById('finalAnalysis').innerHTML='<p style="color:var(--muted)">Could not generate analysis. Review your quarterly results above for insights.</p>';
  }
}

function setupScenarioDefaults(){
  // Hide irrelevant region columns in static grids
  const allRegions=['latam','europe','apac'];
  const activeLC=ACTIVE_REGIONS.map(r=>r.toLowerCase());

  // For each static region grid, hide columns for inactive regions
  // Skip dynamically-generated grids (pricing, production) which handle their own columns
  document.querySelectorAll('.region-grid:not(.dynamic-grid)').forEach(grid=>{
    const cells=Array.from(grid.children);
    // Standard 4-column grid: label + 3 regions
    const cols=4;
    const rows=Math.ceil(cells.length/cols);
    for(let c=1;c<cols;c++){
      const regionName=allRegions[c-1];
      const hide=!activeLC.includes(regionName);
      for(let r=0;r<rows;r++){
        const idx=r*cols+c;
        if(cells[idx]){cells[idx].style.display=hide?'none':''}
      }
    }
    // Adjust grid columns
    grid.style.gridTemplateColumns=`auto repeat(${ACTIVE_REGIONS.length},1fr)`;
  });

  // Set suggested defaults if no saved decisions
  if(!decisions||!decisions.advertising||!Object.keys(decisions.advertising).some(k=>decisions.advertising[k]>0)){
    activeLC.forEach(r=>{
      const adEl=document.getElementById('ad_'+r);if(adEl&&!parseInt(adEl.value))adEl.value=SUGGESTED.ad;
      const semEl=document.getElementById('sem_'+r);if(semEl&&!parseInt(semEl.value))semEl.value=Math.round(SUGGESTED.ad*0.3);
      const sfEl=document.getElementById('sf_'+r);if(sfEl&&(!parseInt(sfEl.value)||parseInt(sfEl.value)<=2))sfEl.value=SUGGESTED.reps;
      const distEl=document.getElementById('dist_'+r);if(distEl&&(!parseInt(distEl.value)||parseInt(distEl.value)<=1))distEl.value=Math.round(SUGGESTED.dist/50000);
    });
    const rdEl=document.getElementById('rdBudget');if(rdEl)rdEl.value=SUGGESTED.rd;
  }
}

function loadBrandList(){
  const container=document.getElementById('brandList');
  if(!brands.length){container.innerHTML='<p style="color:var(--muted);font-size:.85rem">No brands yet. Design your first brand above!</p>';return}
  container.innerHTML=`<h4 style="margin:0 0 6px">Active Brands</h4>
    <p style="font-size:.7rem;color:var(--muted);margin:0 0 8px">üîí Brands are locked once created. Use R&D investment to improve products over time. You can create additional brands targeting different segments.</p>
    <table><thead><tr><th>Brand</th><th>Segment</th><th>Quality</th><th>Unit Cost</th><th>Status</th></tr></thead><tbody>${
    brands.map(b=>{const segName=(COMPONENT_LABELS.segments||{})[b.target_segment]||b.target_segment;return `<tr><td><strong>${esc(b.name)}</strong></td><td>${segName}</td><td>${parseFloat(b.overall_quality||0).toFixed(1)}</td><td>$${Number(b.unit_cost||0).toLocaleString()}</td><td>${b.is_active?'<span style="color:var(--green)">Active</span>':'<span style="color:var(--muted)">Inactive</span>'}</td></tr>`}).join('')
  }</tbody></table>`;
  updatePricingTable();
  updateProductionTable();
}

function updatePricingTable(){
  if(!brands.length)return;
  const container=document.getElementById('pricingTable');
  const cols=ACTIVE_REGIONS.length;
  // Calculate smart suggested price: 35% markup over highest unit cost
  const maxCost=Math.max(...brands.filter(b=>b.is_active).map(b=>parseFloat(b.unit_cost)||0));
  const smartPrice=maxCost>0?Math.ceil((maxCost*1.35)/10)*10:SUGGESTED.price;
  
  container.innerHTML=`<div class="region-grid dynamic-grid" style="grid-template-columns:150px repeat(${cols},1fr)">
    <div class="header">Brand</div>${ACTIVE_REGIONS.map(r=>`<div class="header">${r}</div>`).join('')}
    ${brands.filter(b=>b.is_active).map(b=>{
      const cost=parseFloat(b.unit_cost)||0;
      const defPrice=Math.max(getDecisionPrice(b.id,ACTIVE_REGIONS[0]),Math.ceil((cost*1.35)/10)*10);
      return `<div>${esc(b.name)} <span style="font-size:.7rem;color:var(--muted)">($${Number(cost).toLocaleString()} cost)</span></div>
      ${ACTIVE_REGIONS.map(r=>`<input type="number" id="price_${b.id}_${r}" value="${Math.max(getDecisionPrice(b.id,r),Math.ceil((cost*1.35)/10)*10)}" min="200" max="5000" step="10" onchange="updateDecisions()">`).join('')}`;
    }).join('')}
  </div>
  <p style="font-size:.75rem;color:var(--muted);margin-top:8px">üí° Suggested: ~35% markup over unit cost ($${smartPrice}+). Set price above cost to make profit.</p>`;
}

function updateProductionTable(){
  if(!brands.length)return;
  const container=document.getElementById('productionTable');
  container.innerHTML=`<table><thead><tr><th>Brand</th><th>Units to Produce</th><th>Est. Cost/Unit</th><th>Total Cost</th></tr></thead><tbody>${
    brands.filter(b=>b.is_active).map(b=>{
      const units=getDecisionProd(b.id);
      const cost=parseFloat(b.unit_cost)||0;
      return `<tr>
      <td><strong>${esc(b.name)}</strong></td>
      <td><input type="number" id="prod_${b.id}" value="${units}" min="0" max="50000" step="100" onchange="updateProdTotal('${b.id}',${cost});updateDecisions()" oninput="updateProdTotal('${b.id}',${cost})" style="width:120px"></td>
      <td>$${Number(cost).toLocaleString()}</td>
      <td id="prodtotal_${b.id}">$${Number(units*cost).toLocaleString()}</td>
    </tr>`;
    }).join('')
  }</tbody></table>`;
}
function updateProdTotal(brandId,unitCost){
  const units=parseInt(document.getElementById('prod_'+brandId)?.value)||0;
  const el=document.getElementById('prodtotal_'+brandId);
  if(el) el.textContent='$'+Number(units*unitCost).toLocaleString();
}

function getDecisionPrice(brandId,region){return decisions?.pricing?.[brandId]?.[region]||SUGGESTED.price}
function getDecisionProd(brandId){return decisions?.production?.[brandId]||SUGGESTED.prod}

function collectDecisions(){
  const d={pricing:{},advertising:{},internet_marketing:{},salesforce:{},distribution:{},rd_budget:parseInt(document.getElementById('rdBudget').value)||0,production:{},dividend:parseInt(document.getElementById('dividend').value)||0};
  brands.filter(b=>b.is_active).forEach(b=>{
    d.pricing[b.id]={};d.production[b.id]=parseInt(document.getElementById('prod_'+b.id)?.value)||0;
    ACTIVE_REGIONS.forEach(r=>{d.pricing[b.id][r]=parseInt(document.getElementById(`price_${b.id}_${r}`)?.value)||SUGGESTED.price});
  });
  d.advertising={latam:parseInt(document.getElementById('ad_latam')?.value)||0,europe:parseInt(document.getElementById('ad_europe')?.value)||0,apac:parseInt(document.getElementById('ad_apac')?.value)||0,target:document.getElementById('adTarget')?.value||''};
  d.internet_marketing={latam:parseInt(document.getElementById('sem_latam')?.value)||0,europe:parseInt(document.getElementById('sem_europe')?.value)||0,apac:parseInt(document.getElementById('sem_apac')?.value)||0};
  d.salesforce={};
  ACTIVE_REGIONS.forEach(r=>{const rl=r.toLowerCase();d.salesforce[rl]={count:parseInt(document.getElementById('sf_'+rl)?.value)||0,salary:parseInt(document.getElementById('sfsal_'+rl)?.value)||0,commission:parseInt(document.getElementById('sfcom_'+rl)?.value)||0}});
  d.distribution={latam:parseInt(document.getElementById('dist_latam')?.value)||0,europe:parseInt(document.getElementById('dist_europe')?.value)||0,apac:parseInt(document.getElementById('dist_apac')?.value)||0};
  return d;
}

function updateDecisions(){decisions=collectDecisions()}

async function saveDecisions(){
  decisions=collectDecisions();
  const data=await apiFetch('/api/simulation/submit-decisions',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team?.id,quarter:game.current_quarter,decisions,submit:false})});
  if(data.error)return alert(data.error);
  document.getElementById('submitStatus').textContent='üíæ Draft saved';
}

async function submitDecisions(){
  decisions=collectDecisions();
  console.log('üì§ Submitting Q'+(game.current_quarter)+' decisions:', JSON.stringify({
    distribution: decisions.distribution,
    advertising: {latam: decisions.advertising?.latam, europe: decisions.advertising?.europe},
    salesforce_latam: decisions.salesforce?.latam
  }));
  var btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent='‚è≥ Processing...';
  document.getElementById('submitStatus').textContent='Processing quarter...';
  const data=await apiFetch('/api/simulation/submit-decisions',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team?.id,quarter:game.current_quarter,decisions,submit:true})});
  if(data.code==='PAYWALL'){btn.disabled=false;btn.textContent='Submit Q'+(game.current_quarter||1);showPaywall(data);return;}
  if(data.error){btn.disabled=false;btn.textContent='Submit Q'+(game.current_quarter||1);return alert(data.error);}

  // Quarter processed! Show results summary
  var r=data.results;
  if(r){
    var rank=1;
    if(data.leaderboard){data.leaderboard.forEach(function(t,i){if(t.isPlayer)rank=i+1});}

    // Show in-page modal
    var modal=document.createElement('div');
    modal.id='resultsModal';
    modal.style.cssText='position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7)';
    modal.innerHTML='<div style="background:#1e293b;border-radius:16px;padding:28px;max-width:550px;width:90%;max-height:85vh;overflow:auto;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.5)">'+
      '<h2 style="margin:0 0 16px;color:#34d399">‚úÖ Q'+(data.quarterProcessed)+' Results</h2>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Revenue</div><div style="font-size:1.3rem;font-weight:700">$'+Number(r.revenue||0).toLocaleString()+'</div></div>'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Net Income</div><div style="font-size:1.3rem;font-weight:700;color:'+((r.netIncome||0)>=0?'#34d399':'#f87171')+'">$'+Number(r.netIncome||0).toLocaleString()+'</div></div>'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Market Share</div><div style="font-size:1.3rem;font-weight:700">'+(parseFloat(r.marketShare||0)*100).toFixed(1)+'%</div></div>'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Scorecard</div><div style="font-size:1.3rem;font-weight:700">'+(parseFloat(r.balancedScorecard||0)).toFixed(2)+'</div></div>'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Demand</div><div style="font-size:1.3rem;font-weight:700">'+Number(r.demand||0).toLocaleString()+'</div></div>'+
        '<div style="background:#0f172a;padding:12px;border-radius:8px"><div style="font-size:.7rem;color:#94a3b8">Rank</div><div style="font-size:1.3rem;font-weight:700">#'+rank+' of '+(data.leaderboard?.length||1)+'</div></div>'+
      '</div>'+
      '<p style="text-align:center;color:#94a3b8;margin:0 0 12px">'+(data.gameCompleted?'üéâ Simulation complete!':'Next: Q'+data.nextQuarter)+'</p>'+
      '<button onclick="document.getElementById(\'resultsModal\').remove();location.reload()" style="display:block;width:100%;padding:12px;margin-top:16px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer">Continue ‚Üí</button>'+
      (data._debug ? '<details style="margin-top:12px;font-size:.7rem;color:#94a3b8"><summary>üîß Debug Data</summary><pre style="overflow:auto;max-height:200px;background:#0f172a;padding:8px;border-radius:4px">'+JSON.stringify(data._debug,null,2)+'</pre></details>' : '')+
    '</div>';
    document.body.appendChild(modal);
    return; // Don't reload until user clicks Continue
  }
  // Reload to show new quarter
  location.reload();
}

function showPaywall(data){
  document.getElementById('paywallUsed').textContent=data.decisionsUsed||3;
  document.getElementById('paywallLimit').textContent=data.limit||3;
  document.getElementById('paywallModal').style.display='flex';
}
function closePaywall(){document.getElementById('paywallModal').style.display='none';}

async function createBrand(){
  const name=document.getElementById('brandName').value.trim();
  const segment=document.getElementById('brandSegment').value;
  if(!name)return alert('Please enter a brand name');
  if(!segment)return alert('Please select a target segment');
  if(!team?.id)return alert('No team found. Try refreshing the page.');
  
  // Check for duplicate name
  if(brands.some(b=>b.name.toLowerCase()===name.toLowerCase())){
    return alert('You already have a brand called "'+name+'". Each brand needs a unique name.');
  }
  
  const components={};
  COMPONENTS.forEach(c=>components[c]=parseInt(document.getElementById('comp_'+c).value)||3);
  
  
  const btn=document.querySelector('[onclick="createBrand()"]');
  if(btn){btn.disabled=true;btn.textContent='Creating...';}
  
  const data=await apiFetch('/api/team/brands',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team.id,name,target_segment:segment,components})});
  
  
  if(data.error){alert('Error: '+data.error);if(btn){btn.disabled=false;btn.textContent='Create Brand';}return}
  if(!data.brand){alert('Brand creation failed - no brand returned. Check console.');console.error('Full response:',data);if(btn){btn.disabled=false;btn.textContent='Create Brand';}return}
  
  // Normalize brand properties (API returns camelCase, tables use snake_case)
  const b=data.brand;
  b.is_active=true;
  b.target_segment=b.targetSegment||b.target_segment||segment;
  b.overall_quality=parseFloat(b.overallQuality||b.overall_quality||0);
  b.unit_cost=parseFloat(b.unitCost||b.unit_cost||0);
  if(b.components){
    b.frame_quality=b.components.frame;b.wheels_quality=b.components.wheels;
    b.drivetrain_quality=b.components.drivetrain;b.brakes_quality=b.components.brakes;
    b.suspension_quality=b.components.suspension;b.seat_quality=b.components.seat;
    b.handlebars_quality=b.components.handlebars;b.electronics_quality=b.components.electronics;
  }
  brands.push(b);
  
  // Reset the form for next brand
  document.getElementById('brandName').value='';
  document.getElementById('brandName').placeholder='e.g. '+['Apex','Nova','Pulse','Zen','Spark','Blaze'][Math.floor(Math.random()*6)];
  COMPONENTS.forEach(c=>{document.getElementById('comp_'+c).value=3;document.getElementById('compval_'+c).textContent='3';});
  updateEstCost();
  
  loadBrandList();
  
  // Also reload from server to ensure consistency
  try{
    const fresh=await apiFetch('/api/game/details?game_id='+gameId);
    if(fresh.brands&&fresh.brands.length){
      brands=fresh.brands.map(br=>{br.is_active=true;return br});
      loadBrandList();
    }
  }catch(e){console.log('Brand refresh fallback failed:',e)}
  
  // Visual confirmation
  if(btn){btn.textContent='‚úì '+name+' Created!';btn.style.background='var(--green)';btn.disabled=false;setTimeout(()=>{btn.textContent='Create Brand';btn.style.background=''},2500)}
}

async function loadDecisions(){
  if(!team||!game.current_quarter)return;
  const data=await apiFetch(`/api/simulation/get-decisions?game_id=${gameId}&team_id=${team.id}&quarter=${game.current_quarter}`);
  if(data.decisions){
    decisions=data.decisions;
    // Populate fields from saved decisions
    if(decisions.advertising){
      ['latam','europe','apac'].forEach(r=>{if(document.getElementById('ad_'+r))document.getElementById('ad_'+r).value=decisions.advertising[r]||0});
      if(decisions.advertising.target)document.getElementById('adTarget').value=decisions.advertising.target;
    }
    if(decisions.internet_marketing){['latam','europe','apac'].forEach(r=>{if(document.getElementById('sem_'+r))document.getElementById('sem_'+r).value=decisions.internet_marketing[r]||0})}
    if(decisions.salesforce){ACTIVE_REGIONS.forEach(r=>{const rl=r.toLowerCase();const sf=decisions.salesforce[rl]||{};if(document.getElementById('sf_'+rl)){document.getElementById('sf_'+rl).value=sf.count||0;document.getElementById('sfsal_'+rl).value=sf.salary||40000;document.getElementById('sfcom_'+rl).value=sf.commission||5}})}
    if(decisions.distribution){['latam','europe','apac'].forEach(r=>{if(document.getElementById('dist_'+r))document.getElementById('dist_'+r).value=decisions.distribution[r]||0})}
    if(decisions.rd_budget)document.getElementById('rdBudget').value=decisions.rd_budget;
    if(decisions.dividend)document.getElementById('dividend').value=decisions.dividend;
  }
}

async function loadResults(){
  if(!team||game.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/get-results?game_id=${gameId}&team_id=${team.id}&quarter=${game.current_quarter-1}`);
  const r=data.result||null;
  if(!r)return;
  results=r;

  // Overview tab ‚Äî use camelCase from formatResult()
  document.getElementById('ovCash').textContent='$'+Number(r.endingCash||0).toLocaleString();
  document.getElementById('ovRevenue').textContent='$'+Number(r.revenue||0).toLocaleString();
  document.getElementById('ovIncome').textContent='$'+Number(r.netIncome||0).toLocaleString();
  document.getElementById('ovIncome').className='stat-value '+((r.netIncome||0)>=0?'positive':'negative');
  document.getElementById('ovShare').textContent=(parseFloat(r.marketShare||0)*100).toFixed(1)+'%';
  document.getElementById('ovDemand').textContent=Number(r.demand||0).toLocaleString();
  document.getElementById('ovBSC').textContent=(parseFloat(r.scorecard?.balanced||0)).toFixed(2);

  // Replace "Getting Started" with advisor loading state, then auto-analyze
  document.getElementById('overviewTips').innerHTML='<div id="overviewAdvisor"><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:1.3rem;animation:pulse 1.5s infinite">üß†</span><h3 style="margin:0">AI Advisor analyzing Q'+(game.current_quarter-1)+' performance...</h3></div><p style="color:var(--muted);font-size:.85rem">Reviewing your financials, market position, and competitive landscape...</p></div>';
  loadOverviewAdvisor();

  // Scorecard ‚Äî from nested scorecard object
  const sc=r.scorecard||{};

  // Results tab
  const totalExp=(r.advertisingExpense||0)+(r.salesforceExpense||0)+(r.distributionExpense||0)+(r.internetExpense||0)+(r.rdExpense||0);
  document.getElementById('resultsContent').innerHTML=`
    <div class="scorecard-bar">
      <div class="sc-item sc-total"><div class="label">Total Score</div><div class="score">${(parseFloat(sc.balanced||0)).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Financial</div><div class="score">${(parseFloat(sc.financial||0)).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Market</div><div class="score">${(parseFloat(sc.market||0)).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Mktg Effect.</div><div class="score">${(parseFloat(sc.marketing||0)).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Investment</div><div class="score">${(parseFloat(sc.investment||0)).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Wealth</div><div class="score">${(parseFloat(sc.wealth||0)).toFixed(2)}</div></div>
    </div>
    <div class="panel"><h3>Q${game.current_quarter-1} Performance</h3>
      <div class="panel-grid">
        <div class="stat-card"><div class="stat-label">Revenue</div><div class="stat-value">$${Number(r.revenue||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">COGS</div><div class="stat-value">$${Number(r.cogs||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Expenses</div><div class="stat-value">$${Number(totalExp).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Net Income</div><div class="stat-value ${(r.netIncome||0)>=0?'positive':'negative'}">$${Number(r.netIncome||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Units Sold</div><div class="stat-value">${Number(r.unitsSold||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Stockouts</div><div class="stat-value ${(r.stockouts||0)>0?'negative':''}">${r.stockouts||0}</div></div>
      </div>
    </div>`;

  // Financials tab
  const grossProfit=(r.revenue||0)-(r.cogs||0);
  document.getElementById('financialsContent').innerHTML=`
    <div class="panel"><h3>Income Statement ‚Äî Q${game.current_quarter-1}</h3>
      <table><tbody>
        <tr><td>Revenue</td><td style="text-align:right">$${N(r.revenue)}</td></tr>
        <tr><td>Cost of Goods Sold</td><td style="text-align:right">($${N(r.cogs)})</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Gross Profit</td><td style="text-align:right">$${N(grossProfit)}</td></tr>
        <tr><td>Advertising</td><td style="text-align:right">($${N(r.advertisingExpense)})</td></tr>
        <tr><td>Sales Force</td><td style="text-align:right">($${N(r.salesforceExpense)})</td></tr>
        <tr><td>Distribution</td><td style="text-align:right">($${N(r.distributionExpense)})</td></tr>
        <tr><td>Internet Marketing</td><td style="text-align:right">($${N(r.internetExpense)})</td></tr>
        <tr><td>R&D</td><td style="text-align:right">($${N(r.rdExpense)})</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Operating Profit</td><td style="text-align:right;color:${(r.operatingProfit||0)>=0?'var(--green)':'var(--red)'}">$${N(r.operatingProfit)}</td></tr>
        <tr><td>Tax (25%)</td><td style="text-align:right">($${N(Math.round(Math.max(0,(r.operatingProfit||0))*0.25))})</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Net Income</td><td style="text-align:right;color:${(r.netIncome||0)>=0?'var(--green)':'var(--red)'}">$${N(r.netIncome)}</td></tr>
      </tbody></table>
    </div>
    <div class="panel"><h3>Cash Flow</h3>
      <table><tbody>
        <tr><td>Beginning Cash</td><td style="text-align:right">$${N((r.endingCash||0)-(r.cashFlow||0))}</td></tr>
        <tr><td>Net Income</td><td style="text-align:right">$${N(r.netIncome)}</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Ending Cash</td><td style="text-align:right;color:${(r.endingCash||0)>=0?'var(--green)':'var(--red)'}">$${N(r.endingCash)}</td></tr>
      </tbody></table>
    </div>`;
}

async function loadLeaderboard(){
  if(game?.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/leaderboard?game_id=${gameId}`);
  if(!data.leaderboard)return;
  const container=document.getElementById('leaderboardContent');
  container.innerHTML=data.leaderboard.map(function(t,i){
    var rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
    var isYou=t.is_player||t.isPlayer;
    return '<div class="lb-row" style="'+(isYou?'background:rgba(59,130,246,.08);border:1px solid var(--primary);border-radius:8px;padding:8px 12px':'')+'"><div class="lb-rank '+rankClass+'">#'+(i+1)+'</div><div class="lb-name">'+(t.logo_emoji||'üè¢')+' '+esc(t.name)+(isYou?' <span style="color:var(--primary);font-size:.75rem">YOU</span>':'<span style="color:var(--muted);font-size:.75rem"> ü§ñ AI</span>')+'</div><div class="lb-score">'+(parseFloat(t.cumulative_scorecard||t.balanced_scorecard||0)).toFixed(2)+'</div></div>';
  }).join('');
}

async function loadResearch(){
  if(!team||game?.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/market-research?game_id=${gameId}&quarter=${game.current_quarter-1}`);
  if(!data.research)return;
  const r=data.research;

  // Build segment demand table
  const segments=r.segmentDemands||{};
  const segNames=Object.keys(segments);
  let demandHtml='';
  if(segNames.length>0){
    const regions=Object.keys(segments[segNames[0]]||{});
    demandHtml='<table><thead><tr><th>Segment</th>'+regions.map(rg=>'<th style="text-align:right">'+rg.charAt(0).toUpperCase()+rg.slice(1)+'</th>').join('')+'<th style="text-align:right">Total</th></tr></thead><tbody>';
    for(const seg of segNames){
      const vals=segments[seg]||{};
      const total=Object.values(vals).reduce((s,v)=>s+(parseInt(v)||0),0);
      demandHtml+='<tr><td>'+esc(seg)+'</td>'+regions.map(rg=>'<td style="text-align:right">'+Number(vals[rg]||0).toLocaleString()+'</td>').join('')+'<td style="text-align:right;font-weight:600">'+total.toLocaleString()+'</td></tr>';
    }
    demandHtml+='</tbody></table>';
  }else{
    demandHtml='<p style="color:var(--muted)">No segment demand data available yet.</p>';
  }

  // Build market trends
  const trends=r.marketTrends||{};
  let trendsHtml='<table><tbody>';
  if(trends.totalIndustryDemand!==undefined) trendsHtml+='<tr><td>Total Industry Demand</td><td style="text-align:right">'+Number(trends.totalIndustryDemand||0).toLocaleString()+' units</td></tr>';
  if(trends.averagePrice!==undefined) trendsHtml+='<tr><td>Average Industry Price</td><td style="text-align:right">$'+Number(Math.round(trends.averagePrice||0)).toLocaleString()+'</td></tr>';
  if(trends.growthRate!==undefined) trendsHtml+='<tr><td>Market Growth Rate</td><td style="text-align:right">'+(parseFloat(trends.growthRate||0)*100).toFixed(1)+'%</td></tr>';
  trendsHtml+='<tr><td>Quarter</td><td style="text-align:right">Q'+(trends.quarter||game.current_quarter-1)+'</td></tr>';
  trendsHtml+='</tbody></table>';

  // Build competitor insights
  const competitors=r.competitorPrices||{};
  const judgments=r.brandJudgments||{};
  let compHtml='';
  const compNames=Object.keys(competitors);
  if(compNames.length>0){
    compHtml='<table><thead><tr><th>Company</th><th style="text-align:right">Pricing</th><th style="text-align:right">Brand Score</th><th style="text-align:right">Satisfaction</th></tr></thead><tbody>';
    for(const name of compNames){
      const prices=competitors[name]||{};
      const priceStr=Object.values(prices).filter(v=>typeof v==='number'||!isNaN(v)).map(v=>'$'+Number(v).toLocaleString()).join(', ')||'N/A';
      const j=judgments[name]||{};
      compHtml+='<tr><td>'+esc(name)+'</td><td style="text-align:right">'+priceStr+'</td><td style="text-align:right">'+(parseFloat(j.brandSatisfaction||0)*100).toFixed(0)+'%</td><td style="text-align:right">'+(parseFloat(j.overallSatisfaction||0)*100).toFixed(0)+'%</td></tr>';
    }
    compHtml+='</tbody></table>';
  }

  document.getElementById('researchContent').innerHTML=
    '<div class="panel"><h3>üìä Segment Demand ‚Äî Q'+(game.current_quarter-1)+'</h3>'+demandHtml+'</div>'+
    '<div class="panel"><h3>üìà Market Trends</h3>'+trendsHtml+'</div>'+
    (compHtml?'<div class="panel"><h3>üè¢ Competitor Intelligence</h3>'+compHtml+'</div>':'');
}

function N(v){return Number(v||0).toLocaleString()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

async function loadOverviewAdvisor(){
  if(!results||game.current_quarter<2)return;
  const r=results;
  const sc=r.scorecard||{};
  const lastQ=game.current_quarter-1;

  // Fetch all previous quarters for trend data
  let history=[];
  for(let q=1;q<=lastQ;q++){
    try{
      const d=await apiFetch(`/api/simulation/get-results?game_id=${gameId}&team_id=${team.id}&quarter=${q}`);
      if(d.result)history.push({quarter:q,revenue:d.result.revenue||0,netIncome:d.result.netIncome||0,unitsSold:d.result.unitsSold||0,marketShare:d.result.marketShare||0,endingCash:d.result.endingCash||0,scorecard:d.result.scorecard?.balanced||0});
    }catch(e){}
  }

  // Fetch leaderboard for competitive context
  let leaderboard=[];
  try{
    const lb=await apiFetch(`/api/simulation/leaderboard?game_id=${gameId}`);
    leaderboard=(lb.leaderboard||[]).map(t=>({name:t.name,score:t.score,isPlayer:t.id===team.id}));
  }catch(e){}

  const revTrend=history.map(h=>'Q'+h.quarter+': $'+Number(h.revenue).toLocaleString()).join(' ‚Üí ');
  const incomeTrend=history.map(h=>'Q'+h.quarter+': $'+Number(h.netIncome).toLocaleString()).join(' ‚Üí ');
  const shareTrend=history.map(h=>'Q'+h.quarter+': '+(parseFloat(h.marketShare)*100).toFixed(1)+'%').join(' ‚Üí ');
  const scoreTrend=history.map(h=>'Q'+h.quarter+': '+parseFloat(h.score||h.scorecard||0).toFixed(1)).join(' ‚Üí ');
  const rankInfo=leaderboard.map((t,i)=>'#'+(i+1)+' '+t.name+(t.isPlayer?' (YOU)':' (AI)')+': '+parseFloat(t.score||0).toFixed(1)).join(', ');

  const totalExp=(r.advertisingExpense||0)+(r.salesforceExpense||0)+(r.distributionExpense||0)+(r.internetExpense||0)+(r.rdExpense||0);
  const grossProfit=(r.revenue||0)-(r.cogs||0);

  const prompt=`You are a friendly, sharp marketing strategy advisor in a business simulation game. A student just completed Q${lastQ} of 8. Give them a quick, insightful briefing.

QUARTER ${lastQ} RESULTS:
- Revenue: $${(r.revenue||0).toLocaleString()} | COGS: $${(r.cogs||0).toLocaleString()} | Gross Profit: $${grossProfit.toLocaleString()}
- Expenses: $${totalExp.toLocaleString()} (Ad: $${(r.advertisingExpense||0).toLocaleString()}, Sales: $${(r.salesforceExpense||0).toLocaleString()}, Dist: $${(r.distributionExpense||0).toLocaleString()}, Internet: $${(r.internetExpense||0).toLocaleString()}, R&D: $${(r.rdExpense||0).toLocaleString()})
- Net Income: $${(r.netIncome||0).toLocaleString()} | Cash: $${(r.endingCash||0).toLocaleString()}
- Units Sold: ${r.unitsSold||0} | Demand: ${r.demand||0} | Market Share: ${((r.marketShare||0)*100).toFixed(1)}% | Stockouts: ${r.stockouts||0}

TRENDS ACROSS QUARTERS:
- Revenue: ${revTrend}
- Net Income: ${incomeTrend}
- Market Share: ${shareTrend}

RANKINGS: ${rankInfo}

BRANDS: ${brands.map(b=>b.name+' targeting '+b.target_segment+' at ~$'+(parseFloat(b.unit_cost)||0).toFixed(0)+' unit cost').join('; ')}
QUARTERS REMAINING: ${8-lastQ}

Write a brief advisor briefing in exactly this format. Keep each section to 1-2 sentences. Be specific with numbers and trends. Be encouraging but honest.

ASSESSMENT
One punchy sentence on their overall position and trajectory. Reference their ranking and trend direction.

KEY INSIGHT
The single most important thing they should understand about their current performance. Use specific numbers from the data comparing revenue vs expenses, or market share trend, or competitive gap.

ACTION ITEMS
Exactly 3 bullet points. Each must be a specific, actionable recommendation with a concrete number (e.g., "Cut advertising from $300K to $150K" not "Reduce advertising"). Focus on what will most improve their scorecard.

Keep the total response under 150 words. No fluff, no generic advice. Sound like a smart coach, not a textbook.`;

  try{
    const response=await apiFetch('/api/ai/advisor',{method:'POST',body:JSON.stringify({prompt,max_tokens:600})});
    if(response.error)throw new Error(response.error);
    const text=response.text||'';

    // Parse sections
    let html='<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><span style="font-size:1.3rem">üß†</span><h3 style="margin:0">AI Advisor ‚Äî Q'+lastQ+' Briefing</h3></div>';

    const sections=text.split(/^(ASSESSMENT|KEY INSIGHT|ACTION ITEMS)\s*$/gm);
    const sectionStyles={
      'ASSESSMENT':{icon:'üìä',bg:'transparent',border:'none',pad:'0'},
      'KEY INSIGHT':{icon:'üí°',bg:'rgba(99,102,241,.06)',border:'1px solid rgba(99,102,241,.12)',pad:'12px'},
      'ACTION ITEMS':{icon:'üéØ',bg:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)',pad:'12px'}
    };

    for(let i=1;i<sections.length;i+=2){
      const title=sections[i].trim();
      const body=(sections[i+1]||'').trim();
      if(!body)continue;
      const s=sectionStyles[title]||{icon:'üìã',bg:'transparent',border:'none',pad:'0'};

      let bodyHtml='';
      if(title==='ACTION ITEMS'){
        const items=body.split('\n').filter(l=>l.trim().match(/^[-‚Ä¢\d]/));
        bodyHtml='<ul style="margin:4px 0 0;padding-left:18px">'+items.map(l=>'<li style="margin-bottom:4px;font-size:.88rem;line-height:1.5;color:var(--text-secondary)">'+esc(l.replace(/^[-‚Ä¢\d.)\s]+/,''))+'</li>').join('')+'</ul>';
      }else{
        bodyHtml=body.split('\n').filter(l=>l.trim()).map(l=>'<p style="margin:0 0 4px;font-size:.88rem;line-height:1.5;color:var(--text-secondary)">'+esc(l)+'</p>').join('');
      }

      html+='<div style="margin-bottom:10px;padding:'+s.pad+';background:'+s.bg+';border:'+s.border+';border-radius:8px">';
      if(title!=='ASSESSMENT')html+='<div style="font-size:.75rem;font-weight:600;color:#818cf8;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">'+s.icon+' '+title+'</div>';
      html+=bodyHtml+'</div>';
    }

    // Fallback
    if(sections.length<3){
      html+='<p style="font-size:.88rem;line-height:1.5;color:var(--text-secondary)">'+text.replace(/\n/g,'<br>')+'</p>';
    }

    html+='<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:.7rem;color:var(--muted)">Powered by AI ‚Ä¢ Based on Q'+lastQ+' data</span><button class="btn btn-outline btn-sm" style="font-size:.75rem;padding:4px 10px" onclick="document.querySelector(\'[data-tab=advisor]\').click()">Deep Analysis ‚Üí</button></div>';

    document.getElementById('overviewTips').innerHTML=html;

  }catch(err){
    console.error('Overview advisor error:',err);
    document.getElementById('overviewTips').innerHTML='<h3>üìà Q'+(game.current_quarter-1)+' Summary</h3><p style="color:var(--muted);font-size:.9rem;line-height:1.6">You sold '+Number(r.unitsSold||0).toLocaleString()+' units generating $'+Number(r.revenue||0).toLocaleString()+' in revenue. Net income was $'+Number(r.netIncome||0).toLocaleString()+'.</p>';
  }
}

async function getAdvisorAnalysis(){
  if(!results||game.current_quarter<2){
    alert('Play at least one quarter first to get advisor recommendations.');
    return;
  }

  const btn=document.getElementById('advisorBtn');
  const content=document.getElementById('advisorContent');
  const loading=document.getElementById('advisorLoading');
  const empty=document.getElementById('advisorEmpty');

  btn.disabled=true;
  empty.style.display='none';
  content.style.display='none';
  loading.style.display='block';

  // Gather all context for the advisor
  const r=results;
  const sc=r.scorecard||{};
  const sat=r.satisfaction||{};
  const lastQ=game.current_quarter-1;

  // Fetch history for trends
  let history=[];
  for(let q=1;q<=lastQ;q++){
    try{
      const d=await apiFetch(`/api/simulation/get-results?game_id=${gameId}&team_id=${team.id}&quarter=${q}`);
      if(d.result)history.push({quarter:q,revenue:d.result.revenue||0,netIncome:d.result.netIncome||0,unitsSold:d.result.unitsSold||0,marketShare:d.result.marketShare||0,endingCash:d.result.endingCash||0});
    }catch(e){}
  }
  const revTrend=history.map(h=>'Q'+h.quarter+': $'+Number(h.revenue).toLocaleString()).join(' ‚Üí ');
  const incomeTrend=history.map(h=>'Q'+h.quarter+': $'+Number(h.netIncome).toLocaleString()).join(' ‚Üí ');

  const prompt=`You are a marketing strategy advisor for a business simulation game. A student is running a company in a competitive market simulation with AI opponents.

Here is their current situation after Q${lastQ}:

FINANCIAL RESULTS:
- Revenue: $${(r.revenue||0).toLocaleString()}
- Cost of Goods: $${(r.cogs||0).toLocaleString()}  
- Gross Profit: $${((r.revenue||0)-(r.cogs||0)).toLocaleString()}
- Total Operating Expenses: $${((r.advertisingExpense||0)+(r.salesforceExpense||0)+(r.distributionExpense||0)+(r.internetExpense||0)+(r.rdExpense||0)).toLocaleString()}
  (Advertising: $${(r.advertisingExpense||0).toLocaleString()}, Sales Force: $${(r.salesforceExpense||0).toLocaleString()}, Distribution: $${(r.distributionExpense||0).toLocaleString()}, Internet: $${(r.internetExpense||0).toLocaleString()}, R&D: $${(r.rdExpense||0).toLocaleString()})
- Net Income: $${(r.netIncome||0).toLocaleString()}
- Ending Cash: $${(r.endingCash||0).toLocaleString()}

TRENDS:
- Revenue: ${revTrend}
- Net Income: ${incomeTrend}

MARKET PERFORMANCE:
- Units Sold: ${r.unitsSold||0}
- Total Demand: ${r.demand||0}
- Market Share: ${((r.marketShare||0)*100).toFixed(1)}%

SCORECARD (0-100 scale, current total: ${(sc.balanced||0).toFixed(1)}):
- Financial: ${sc.financial} | Market: ${(sc.market||0).toFixed(2)} | Marketing Effectiveness: ${(sc.marketing||0).toFixed(2)} | Investment: ${(sc.investment||0).toFixed(1)} | Wealth Creation: ${(sc.wealth||0).toFixed(2)}

BRANDS: ${brands.map(b=>b.name+' targeting '+b.target_segment+' (unit cost: $'+(parseFloat(b.unit_cost)||0).toFixed(0)+')').join('; ')}
QUARTER: ${lastQ} of 8 (${8-lastQ} quarters remaining)

Provide strategic advice in this exact format (use these exact section headers):

PERFORMANCE SUMMARY
2-3 sentences summarizing their current position ‚Äî what's working and what's not.

TOP PRIORITIES
3-4 specific, actionable recommendations ranked by impact. Each should be one clear sentence with a specific number or action (e.g., "Reduce advertising from $200K to $120K" not "Consider reducing advertising").

WATCH OUT
1-2 risks or pitfalls to avoid next quarter.

COMPETITIVE EDGE
One specific move that could help them gain ground on the AI competitors.

Keep it concise, direct, and encouraging. Use specific numbers from their data. This is an educational simulation so help them learn marketing strategy principles.`;

  try{
    const response=await apiFetch('/api/ai/advisor',{method:'POST',body:JSON.stringify({prompt,max_tokens:1000})});
    if(response.error)throw new Error(response.error);
    const text=response.text||'Unable to generate analysis.';

    // Parse sections and render
    const sections=[];
    const sectionPattern=/^(PERFORMANCE SUMMARY|TOP PRIORITIES|WATCH OUT|COMPETITIVE EDGE)\s*$/gm;
    const parts=text.split(sectionPattern);
    
    // Build HTML from parsed sections
    let html='';
    const icons={'PERFORMANCE SUMMARY':'üìã','TOP PRIORITIES':'üéØ','WATCH OUT':'‚ö†Ô∏è','COMPETITIVE EDGE':'‚ö°'};
    const classes={'PERFORMANCE SUMMARY':'advisor-section','TOP PRIORITIES':'advisor-section advisor-highlight','WATCH OUT':'advisor-section advisor-warning','COMPETITIVE EDGE':'advisor-section advisor-highlight'};

    for(let i=1;i<parts.length;i+=2){
      const title=parts[i].trim();
      const body=(parts[i+1]||'').trim();
      if(!body)continue;

      // Convert markdown-style lists to HTML
      let bodyHtml=body.split('\n').filter(l=>l.trim()).map(line=>{
        line=line.trim();
        if(line.match(/^\d+\.\s/))return '<li>'+esc(line.replace(/^\d+\.\s/,''))+'</li>';
        if(line.match(/^[-‚Ä¢]\s/))return '<li>'+esc(line.replace(/^[-‚Ä¢]\s/,''))+'</li>';
        return '<p>'+esc(line)+'</p>';
      }).join('');

      // Wrap list items in ul
      if(bodyHtml.includes('<li>')){
        bodyHtml=bodyHtml.replace(/(<li>.*<\/li>)/s,'<ul>$1</ul>');
      }

      html+='<div class="'+(classes[title]||'advisor-section')+'"><h4>'+(icons[title]||'üí°')+' '+title+'</h4>'+bodyHtml+'</div>';
    }

    // Fallback if parsing didn't work
    if(!html){
      html='<div class="advisor-section"><h4>üìã Analysis</h4><p>'+text.replace(/\n/g,'<br>')+'</p></div>';
    }

    html+='<div class="advisor-meta"><span>Based on Q'+lastQ+' results</span><button class="btn btn-outline btn-sm" onclick="getAdvisorAnalysis()">üîÑ Refresh Analysis</button></div>';

    content.innerHTML=html;
    content.style.display='block';
    loading.style.display='none';
    btn.disabled=false;

  }catch(err){
    console.error('Advisor error:',err);
    loading.style.display='none';
    empty.style.display='block';
    btn.disabled=false;
    content.innerHTML='<div class="advisor-section advisor-warning"><h4>‚ö†Ô∏è Advisor Unavailable</h4><p>Could not connect to the AI advisor. Please try again.</p></div>';
    content.style.display='block';
  }
}

init();
</script>
<!-- Paywall Modal -->
<div id="paywallModal" class="paywall-overlay" style="display:none">
  <div class="paywall-box">
    <div class="paywall-header">
      <div class="pw-icon">üîí</div>
      <h2>Free Preview Complete!</h2>
      <p>You've used <span id="paywallUsed">3</span> of <span id="paywallLimit">3</span> free decisions</p>
    </div>
    <div class="paywall-progress">
      <div class="pw-bar"><div class="pw-bar-fill" style="width:37.5%"></div></div>
      <div class="pw-labels"><span>Q3 of 8</span><span class="locked">üîí Q4‚ÄìQ8 locked</span></div>
    </div>
    <div class="paywall-benefits">
      <h3>Upgrade to unlock:</h3>
      <ul>
        <li>Complete all 8 quarters</li>
        <li>All 4 industry scenarios</li>
        <li>Unlimited decisions</li>
        <li>Detailed analytics & leaderboard</li>
        <li>Priority support</li>
      </ul>
    </div>
    <div class="paywall-pricing">
      <div class="pw-price-card" onclick="location.href='/pricing.html'">
        <div class="pw-amt">$19</div>
        <div class="pw-per">/month</div>
        <div class="pw-tag">Cancel anytime</div>
      </div>
      <div class="pw-price-card" onclick="location.href='/pricing.html'">
        <div class="pw-amt">$149</div>
        <div class="pw-per">one-time</div>
        <div class="pw-tag">üî• Best value</div>
      </div>
    </div>
    <div class="paywall-actions">
      <button class="pw-btn-upgrade" onclick="location.href='/pricing.html'">üöÄ Upgrade to Pro</button>
      <button class="pw-btn-later" onclick="closePaywall()">Maybe later</button>
    </div>
  </div>
</div>

<!-- ===== INTERACTIVE STEP-BY-STEP GUIDE ===== -->
<div id="guidePanel" style="display:none">
  <div id="guideProgress"><div id="guideProgressFill"></div></div>
  <div id="guideHeader">
    <span id="guideStepLabel"></span>
    <div>
      <button id="guideMinBtn" onclick="toggleGuideMin()" title="Minimize">‚îÄ</button>
      <button id="guideCloseBtn" onclick="closeGuide()" title="Close guide">‚úï</button>
    </div>
  </div>
  <div id="guideBody">
    <div id="guideIconRow"><span id="guideIcon"></span><h3 id="guideTitle"></h3></div>
    <p id="guideDesc"></p>
    <div id="guideTip"></div>
    <div id="guideChecklist"></div>
  </div>
  <div id="guideFooter">
    <button id="guidePrev" onclick="guideNav(-1)">‚Üê Back</button>
    <div id="guideDots"></div>
    <button id="guideNext" onclick="guideNav(1)">Next Step ‚Üí</button>
  </div>
</div>

<!-- Minimized pill -->
<div id="guideMini" style="display:none" onclick="toggleGuideMin()">
  <span id="guideMiniIcon"></span>
  <span id="guideMiniText"></span>
  <span id="guideMiniStep"></span>
</div>

<!-- Floating help button -->
<button id="guideHelpBtn" onclick="startGuide()" title="Step-by-Step Guide">‚ùì</button>

<style>
/* ‚îÄ‚îÄ Floating Guide Panel ‚îÄ‚îÄ */
#guidePanel{
  position:fixed;bottom:24px;left:24px;z-index:2000;
  width:360px;max-height:85vh;
  background:linear-gradient(160deg,#1a1f36 0%,#0f172a 100%);
  border:1px solid rgba(99,102,241,.35);
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.5),0 0 30px rgba(99,102,241,.12);
  display:flex;flex-direction:column;
  overflow:hidden;
  animation:guidePop .3s ease;
}
@keyframes guidePop{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}

#guideProgress{height:3px;background:#0f172a;flex-shrink:0;border-radius:16px 16px 0 0;overflow:hidden}
#guideProgressFill{height:100%;background:linear-gradient(90deg,#6366f1,#a78bfa);transition:width .5s ease;width:0}

#guideHeader{display:flex;justify-content:space-between;align-items:center;padding:12px 16px 4px;flex-shrink:0}
#guideStepLabel{font-size:.7rem;color:#818cf8;font-weight:700;text-transform:uppercase;letter-spacing:1.5px}
#guideMinBtn,#guideCloseBtn{background:none;border:none;color:#475569;font-size:.9rem;cursor:pointer;padding:2px 8px;border-radius:4px;transition:all .15s}
#guideMinBtn:hover,#guideCloseBtn:hover{background:rgba(255,255,255,.08);color:#94a3b8}

#guideBody{padding:4px 18px 12px;overflow-y:auto;flex:1}
#guideIconRow{display:flex;align-items:center;gap:10px;margin-bottom:8px}
#guideIcon{font-size:1.8rem;flex-shrink:0}
#guideTitle{color:white;font-size:1.1rem;margin:0;font-weight:700}
#guideDesc{color:#94a3b8;font-size:.88rem;line-height:1.55;margin:0 0 12px}

#guideTip{
  background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.2);
  border-radius:10px;padding:10px 14px;font-size:.82rem;color:#a5b4fc;
  margin-bottom:14px;display:none;line-height:1.5;
}
#guideTip::before{content:'üí° '}

/* ‚îÄ‚îÄ Checklist ‚îÄ‚îÄ */
#guideChecklist{display:flex;flex-direction:column;gap:6px;margin-bottom:4px}
.guide-check{
  display:flex;align-items:center;gap:10px;
  padding:8px 12px;border-radius:8px;font-size:.82rem;color:#94a3b8;
  background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);
  cursor:pointer;transition:all .2s;user-select:none;
}
.guide-check:hover{background:rgba(255,255,255,.04)}
.guide-check.done{color:#34d399;border-color:rgba(52,211,153,.15);background:rgba(52,211,153,.05)}
.guide-check-box{
  width:18px;height:18px;border-radius:5px;border:2px solid #334155;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  font-size:.7rem;transition:all .2s;
}
.guide-check.done .guide-check-box{border-color:#34d399;background:#34d399;color:#0f172a}
.guide-check.current{color:#c7d2fe;border-color:rgba(99,102,241,.3);background:rgba(99,102,241,.06)}
.guide-check.current .guide-check-box{border-color:#6366f1;box-shadow:0 0 8px rgba(99,102,241,.3)}

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
#guideFooter{display:flex;justify-content:space-between;align-items:center;padding:10px 16px 14px;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
#guideDots{display:flex;gap:5px}
.guide-dot{width:6px;height:6px;border-radius:50%;background:#1e293b;transition:all .25s}
.guide-dot.active{background:#6366f1;transform:scale(1.4)}
.guide-dot.done{background:#4f46e5}
#guidePrev,#guideNext{border:1px solid #1e293b;color:#64748b;padding:7px 14px;border-radius:8px;cursor:pointer;font-size:.82rem;font-weight:500;transition:all .15s;background:none}
#guidePrev:hover{border-color:#475569;color:white}
#guidePrev:disabled{opacity:.25;pointer-events:none}
#guideNext{background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;color:white;font-weight:600}
#guideNext:hover{opacity:.9}

/* ‚îÄ‚îÄ Minimized Pill ‚îÄ‚îÄ */
#guideMini{
  position:fixed;bottom:24px;left:24px;z-index:2000;
  background:linear-gradient(135deg,#1a1f36,#0f172a);
  border:1px solid rgba(99,102,241,.3);border-radius:40px;
  padding:10px 18px;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  transition:all .2s;animation:guidePop .3s ease;
}
#guideMini:hover{border-color:rgba(99,102,241,.5);transform:translateY(-2px)}
#guideMiniIcon{font-size:1.1rem}
#guideMiniText{color:#c7d2fe;font-size:.82rem;font-weight:500}
#guideMiniStep{background:#6366f1;color:white;font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:700}

/* ‚îÄ‚îÄ Help Button ‚îÄ‚îÄ */
#guideHelpBtn{
  position:fixed;bottom:24px;left:24px;z-index:100;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;
  width:48px;height:48px;border-radius:50%;font-size:1.3rem;cursor:pointer;
  box-shadow:0 4px 15px rgba(99,102,241,.4);transition:all .2s;
  display:flex;align-items:center;justify-content:center;
}
#guideHelpBtn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(99,102,241,.5)}

/* ‚îÄ‚îÄ Sidebar highlight ‚îÄ‚îÄ */
.sidebar-item.guide-highlight{
  background:rgba(99,102,241,.12)!important;
  border-left-color:#8b5cf6!important;
  animation:sideGlow 2s ease-in-out infinite;
}
@keyframes sideGlow{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 10px rgba(99,102,241,.12)}}

/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media(max-width:500px){
  #guidePanel{width:calc(100vw - 16px);left:8px;bottom:8px;max-height:60vh}
}
</style>

<script>
const GUIDE_STEPS=[
  {
    icon:'üéØ',title:'Welcome!',
    desc:'You\'re the marketing director of a tech company. Each quarter, complete the steps below ‚Äî then submit to see results vs AI competitors.',
    tip:'This simulation runs 8 quarters. Follow these steps from top to bottom each quarter, then click Submit.',
    tab:'overview',
    checks:['Look over the Overview tab','Note your starting cash ($6M)','Click Next Step when ready']
  },
  {
    icon:'üè∑Ô∏è',title:'Create Your Brand',
    desc:'Design your first product. Name it, choose a target customer segment, then set component quality with the sliders.',
    tip:'Higher quality = better appeal but higher unit cost. Check the "Est. Unit Cost" before clicking Create. You can make multiple brands later!',
    tab:'brands',
    checks:['Enter a brand name','Choose a target segment','Adjust component sliders','Click "Create Brand"']
  },
  {
    icon:'üí≤',title:'Set Your Prices',
    desc:'Set a retail price for each brand in each region. This directly drives revenue and shapes how customers see you.',
    tip:'Price above your unit cost to make profit. Budget-conscious segments are very price-sensitive; premium segments tolerate higher prices.',
    tab:'pricing',
    checks:['Set price for each brand/region','Ensure price > unit cost']
  },
  {
    icon:'üì£',title:'Plan Advertising',
    desc:'Allocate advertising budget per region and pick which segment to target. More spend = more awareness.',
    tip:'Focus budget on regions where you have strong products. Even a small ad spend ($50K‚Äì$200K) beats zero.',
    tab:'advertising',
    checks:['Set ad budget per region','Pick your ad target segment']
  },
  {
    icon:'üë•',title:'Hire Sales Force',
    desc:'Set the number of sales reps and their compensation in each region. They drive direct sales.',
    tip:'Reps take a quarter to fully ramp up. Hire early and maintain your team ‚Äî turnover hurts.',
    tab:'salesforce',
    checks:['Set number of reps per region','Set compensation level']
  },
  {
    icon:'üè™',title:'Set Up Distribution',
    desc:'Allocate distribution support budget per region to get your products into stores and channels.',
    tip:'Match your channels to where your target customers actually shop.',
    tab:'distribution',
    checks:['Set distribution budget per region']
  },
  {
    icon:'üè≠',title:'Set Production Volume',
    desc:'Decide how many units to produce for each brand. Too few = stockouts. Too many = excess costs.',
    tip:'For Q1, try 500‚Äì2,000 units per brand. Adjust each quarter based on demand results.',
    tab:'production',
    checks:['Set production quantity per brand']
  },
  {
    icon:'üî¨',title:'Invest in R&D',
    desc:'Set your R&D budget to improve product quality over time. Benefits compound across quarters.',
    tip:'Even $50K‚Äì$200K per quarter adds up significantly. Don\'t skip this ‚Äî it\'s your long-term edge.',
    tab:'rd',
    checks:['Set your R&D budget amount']
  },
  {
    icon:'üöÄ',title:'Submit Your Quarter!',
    desc:'Review everything on the Overview tab, then click "Submit Quarter" at the bottom. Results appear instantly!',
    tip:'After submitting, check Results üìà, Financials üí∞, and Rankings üèÜ to see how you did. Then start Q2!',
    tab:'overview',
    checks:['Review all your decisions','Click "Submit Quarter"']
  }
];

let guideCurrent=0;
let guideMinimized=false;
let guideChecked={};

function startGuide(){
  guideCurrent=0;
  guideMinimized=false;
  guideChecked={};
  document.getElementById('guidePanel').style.display='flex';
  document.getElementById('guideMini').style.display='none';
  document.getElementById('guideHelpBtn').style.display='none';
  renderGuide();
}

function closeGuide(){
  document.getElementById('guidePanel').style.display='none';
  document.getElementById('guideMini').style.display='none';
  document.getElementById('guideHelpBtn').style.display='flex';
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('guide-highlight'));
  try{localStorage.setItem('marketsim_guide_seen','1')}catch(e){}
}

function toggleGuideMin(){
  guideMinimized=!guideMinimized;
  if(guideMinimized){
    document.getElementById('guidePanel').style.display='none';
    const s=GUIDE_STEPS[guideCurrent];
    document.getElementById('guideMiniIcon').textContent=s.icon;
    document.getElementById('guideMiniText').textContent=s.title;
    document.getElementById('guideMiniStep').textContent=(guideCurrent+1)+'/'+GUIDE_STEPS.length;
    document.getElementById('guideMini').style.display='flex';
  }else{
    document.getElementById('guideMini').style.display='none';
    document.getElementById('guidePanel').style.display='flex';
    renderGuide();
  }
}

function guideNav(dir){
  guideCurrent+=dir;
  if(guideCurrent>=GUIDE_STEPS.length){closeGuide();return}
  if(guideCurrent<0)guideCurrent=0;
  if(guideMinimized){
    guideMinimized=false;
    document.getElementById('guideMini').style.display='none';
    document.getElementById('guidePanel').style.display='flex';
  }
  renderGuide();
}

function toggleCheck(stepIdx,checkIdx){
  const key=stepIdx+'-'+checkIdx;
  guideChecked[key]=!guideChecked[key];
  renderGuide();
}

function renderGuide(){
  const s=GUIDE_STEPS[guideCurrent];
  const total=GUIDE_STEPS.length;

  // Progress
  document.getElementById('guideProgressFill').style.width=((guideCurrent/(total-1))*100)+'%';
  document.getElementById('guideStepLabel').textContent=
    guideCurrent===0?'Getting Started':`Step ${guideCurrent} of ${total-1}`;

  // Content
  document.getElementById('guideIcon').textContent=s.icon;
  document.getElementById('guideTitle').textContent=s.title;
  document.getElementById('guideDesc').textContent=s.desc;

  const tipEl=document.getElementById('guideTip');
  if(s.tip){tipEl.textContent=s.tip;tipEl.style.display='block'}
  else tipEl.style.display='none';

  // Navigate tab + highlight sidebar
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('guide-highlight'));
  if(s.tab){
    document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    const tabItem=document.querySelector(`.sidebar-item[data-tab="${s.tab}"]`);
    if(tabItem){tabItem.classList.add('active','guide-highlight')}
    const tabContent=document.getElementById('tab-'+s.tab);
    if(tabContent)tabContent.classList.add('active');
  }

  // Checklist
  const clEl=document.getElementById('guideChecklist');
  if(s.checks&&s.checks.length){
    // Find first unchecked for "current" highlight
    let firstUnchecked=-1;
    s.checks.forEach((c,i)=>{if(!guideChecked[guideCurrent+'-'+i]&&firstUnchecked===-1)firstUnchecked=i});

    clEl.innerHTML=s.checks.map((c,i)=>{
      const done=guideChecked[guideCurrent+'-'+i];
      const isCurrent=!done&&i===firstUnchecked;
      return `<div class="guide-check ${done?'done':isCurrent?'current':''}" onclick="toggleCheck(${guideCurrent},${i})">
        <div class="guide-check-box">${done?'‚úì':''}</div>
        <span>${c}</span>
      </div>`;
    }).join('');
  }else clEl.innerHTML='';

  // Dots
  document.getElementById('guideDots').innerHTML=GUIDE_STEPS.map((_,i)=>
    `<div class="guide-dot ${i===guideCurrent?'active':i<guideCurrent?'done':''}"></div>`
  ).join('');

  // Buttons
  document.getElementById('guidePrev').disabled=guideCurrent===0;
  document.getElementById('guideNext').textContent=
    guideCurrent===total-1?'Finish Guide ‚úì':'Next Step ‚Üí';
}

// Auto-show on first Q1 visit
window.addEventListener('load',()=>{
  setTimeout(()=>{
    try{if(localStorage.getItem('marketsim_guide_seen'))return}catch(e){}
    if(game && game.current_quarter<=1)startGuide();
  },1200);
});
</script>

</body>
</html>
