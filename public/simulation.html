<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulation ‚Äî MarketSim Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#111827;--border:#1e293b;--primary:#3b82f6;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#e2e8f0;--muted:#94a3b8;--surface:#1e293b}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
.btn{padding:8px 20px;border-radius:8px;border:none;font-weight:600;font-size:.85rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
.btn-primary:hover{transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary)}
.btn-green{background:var(--green);color:#fff;padding:10px 28px;font-size:.95rem}
.btn-green:hover{opacity:.9}
.btn-sm{padding:6px 14px;font-size:.8rem}
select,input[type=number],input[type=text]{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.85rem;font-family:inherit}
select:focus,input:focus{outline:none;border-color:var(--primary)}

/* Top Bar */
.topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 24px;border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:16px}
.topbar .logo{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.game-info{display:flex;align-items:center;gap:12px;font-size:.85rem;color:var(--muted)}
.game-info .code{background:var(--surface);padding:3px 10px;border-radius:4px;font-family:monospace;color:var(--yellow)}
.quarter-badge{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:4px 14px;border-radius:20px;font-weight:700;font-size:.85rem}
.topbar-right{display:flex;align-items:center;gap:10px}

/* Layout */
.app-layout{display:flex;flex:1;overflow:hidden}

/* Sidebar */
.sidebar{width:220px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-section{padding:8px 0}
.sidebar-label{font-size:.7rem;text-transform:uppercase;color:var(--muted);padding:8px 16px 4px;letter-spacing:.05em;font-weight:600}
.sidebar-item{display:flex;align-items:center;gap:8px;padding:8px 16px;font-size:.85rem;cursor:pointer;transition:all .15s;color:var(--muted);border-left:3px solid transparent}
.sidebar-item:hover{background:rgba(59,130,246,.05);color:var(--text)}
.sidebar-item.active{background:rgba(59,130,246,.08);color:var(--primary);border-left-color:var(--primary);font-weight:600}
.sidebar-divider{height:1px;background:var(--border);margin:4px 0}
.sidebar-footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--border)}

/* Main Content */
.main{flex:1;overflow-y:auto;padding:24px}
.main h2{font-size:1.3rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.tab-content{display:none}.tab-content.active{display:block}

/* Cards & Panels */
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
.panel h3{font-size:1rem;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.panel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.stat-card{background:var(--surface);border-radius:10px;padding:16px}
.stat-label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
.stat-value{font-size:1.4rem;font-weight:700;margin-top:4px}
.stat-value.positive{color:var(--green)}.stat-value.negative{color:var(--red)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;padding:8px 12px;color:var(--muted);font-size:.75rem;text-transform:uppercase;border-bottom:1px solid var(--border);font-weight:600}
td{padding:8px 12px;border-bottom:1px solid rgba(30,41,59,.5)}
tr:hover td{background:rgba(59,130,246,.03)}

/* Brand Builder */
.brand-form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.component-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(30,41,59,.3)}
.component-label{font-size:.85rem;min-width:120px}
.component-slider{display:flex;align-items:center;gap:8px;flex:1}
.component-slider input[type=range]{flex:1;accent-color:var(--primary)}
.component-slider .val{min-width:24px;text-align:center;font-weight:600;color:var(--primary)}

/* Region inputs */
.region-grid{display:grid;grid-template-columns:120px repeat(3,1fr);gap:8px;align-items:center}
.region-grid .header{font-size:.75rem;color:var(--muted);text-transform:uppercase;font-weight:600}

/* Scorecard */
.scorecard-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
.sc-item{background:var(--surface);border-radius:10px;padding:14px 18px;flex:1;min-width:140px;text-align:center}
.sc-item .label{font-size:.7rem;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.sc-item .score{font-size:1.6rem;font-weight:700}
.sc-total .score{background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

/* Leaderboard */
.lb-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border-radius:10px;margin-bottom:8px}
.lb-rank{font-size:1.3rem;font-weight:700;min-width:32px;text-align:center}
.lb-rank.gold{color:#fbbf24}.lb-rank.silver{color:#94a3b8}.lb-rank.bronze{color:#d97706}
.lb-name{flex:1;font-weight:600}.lb-score{font-size:1.1rem;font-weight:700;color:var(--primary)}

/* Submit bar */
.submit-bar{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.submit-bar .status{font-size:.85rem;color:var(--muted)}
.submit-bar .status.submitted{color:var(--green)}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--muted)}

/* Instructor panel */
/* Solo mode only ‚Äî no instructor panel */

@media(max-width:900px){.sidebar{width:60px}.sidebar-item span{display:none}.sidebar-label{display:none}}
/* Paywall modal */
.paywall-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:pwFadeIn .3s ease}
@keyframes pwFadeIn{from{opacity:0}to{opacity:1}}
.paywall-box{background:#fff;border-radius:24px;max-width:460px;width:90%;overflow:hidden;animation:pwSlideUp .3s ease;box-shadow:0 25px 50px rgba(0,0,0,.25)}
@keyframes pwSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.paywall-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:32px;text-align:center}
.paywall-header .pw-icon{font-size:48px;margin-bottom:12px}
.paywall-header h2{font-size:1.6rem;margin:0 0 6px}
.paywall-header p{margin:0;opacity:.9;font-size:.95rem}
.paywall-progress{padding:20px 32px;border-bottom:1px solid #f1f5f9}
.pw-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:10px}
.pw-bar-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:4px}
.pw-labels{display:flex;justify-content:space-between;font-size:.8rem;color:#64748b}
.pw-labels .locked{color:#ef4444}
.paywall-benefits{padding:24px 32px}
.paywall-benefits h3{margin:0 0 14px;color:#1e293b;font-size:1rem}
.paywall-benefits ul{list-style:none;padding:0;margin:0}
.paywall-benefits li{padding:7px 0;color:#475569;font-size:.9rem}
.paywall-benefits li::before{content:'‚úì ';color:#10b981;font-weight:700}
.paywall-pricing{display:flex;gap:12px;padding:0 32px;margin-bottom:8px}
.pw-price-card{flex:1;background:#f8fafc;border-radius:12px;padding:16px;text-align:center;border:2px solid transparent;cursor:pointer;transition:all .2s}
.pw-price-card:hover,.pw-price-card.selected{border-color:#6366f1}
.pw-price-card .pw-amt{font-size:1.8rem;font-weight:800;color:#1e293b}
.pw-price-card .pw-per{font-size:.82rem;color:#64748b}
.pw-price-card .pw-tag{font-size:.7rem;color:#10b981;font-weight:600;margin-top:4px}
.paywall-actions{padding:20px 32px 28px;display:flex;flex-direction:column;gap:10px}
.pw-btn-upgrade{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:14px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit}
.pw-btn-upgrade:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,.4)}
.pw-btn-later{background:none;border:none;color:#64748b;padding:10px;cursor:pointer;font-size:.88rem;font-family:inherit}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <a href="/dashboard.html" class="logo">üéØ MarketSim</a>
    <div class="game-info">
      <span id="gameName">Loading...</span>
      <span class="quarter-badge" id="quarterBadge">Q0</span>
    </div>
  </div>
  <div class="topbar-right">
    <span id="teamName" style="font-size:.85rem;color:var(--muted)"></span>
    <span id="cashDisplay" style="font-size:.85rem;font-weight:600;color:var(--green)"></span>
    <button class="btn btn-outline btn-sm" onclick="window.location.href='/dashboard.html'">‚Üê Dashboard</button>
  </div>
</div>

<div class="app-layout">
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Decisions</div>
      <div class="sidebar-item active" data-tab="overview"><span>üìä</span><span>Overview</span></div>
      <div class="sidebar-item" data-tab="brands"><span>üè∑Ô∏è</span><span>Brands</span></div>
      <div class="sidebar-item" data-tab="pricing"><span>üí≤</span><span>Pricing</span></div>
      <div class="sidebar-item" data-tab="advertising"><span>üì£</span><span>Advertising</span></div>
      <div class="sidebar-item" data-tab="salesforce"><span>üë•</span><span>Sales Force</span></div>
      <div class="sidebar-item" data-tab="distribution"><span>üè™</span><span>Distribution</span></div>
      <div class="sidebar-item" data-tab="production"><span>üè≠</span><span>Production</span></div>
      <div class="sidebar-item" data-tab="rd"><span>üî¨</span><span>R&D</span></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-label">Reports</div>
      <div class="sidebar-item" data-tab="results"><span>üìà</span><span>Results</span></div>
      <div class="sidebar-item" data-tab="financials"><span>üí∞</span><span>Financials</span></div>
      <div class="sidebar-item" data-tab="research"><span>üîç</span><span>Market Research</span></div>
      <div class="sidebar-item" data-tab="leaderboard"><span>üèÜ</span><span>Rankings vs AI</span></div>
    </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn btn-green" style="width:100%" onclick="submitDecisions()" id="submitBtn">Submit Q<span id="submitQ">1</span></button>
    </div>
  </div>

  <div class="main" id="mainContent">

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <h2>üìä Quarter Overview</h2>
      <div class="panel-grid" id="overviewStats">
        <div class="stat-card"><div class="stat-label">Cash Balance</div><div class="stat-value" id="ovCash">$5,000,000</div></div>
        <div class="stat-card"><div class="stat-label">Revenue (Last Q)</div><div class="stat-value" id="ovRevenue">$0</div></div>
        <div class="stat-card"><div class="stat-label">Net Income (Last Q)</div><div class="stat-value" id="ovIncome">$0</div></div>
        <div class="stat-card"><div class="stat-label">Market Share</div><div class="stat-value" id="ovShare">0%</div></div>
        <div class="stat-card"><div class="stat-label">Total Demand</div><div class="stat-value" id="ovDemand">0</div></div>
        <div class="stat-card"><div class="stat-label">Balanced Scorecard</div><div class="stat-value" id="ovBSC">0.0</div></div>
      </div>
      <div class="panel" id="overviewTips">
        <h3>üí° Getting Started</h3>
        <p style="color:var(--muted);font-size:.9rem;line-height:1.6" id="tipText">Start by designing your first brand in the Brands tab. Then set pricing, plan your advertising, hire sales staff, and set up distribution. When ready, click Submit to lock in your decisions for this quarter.</p>
      </div>
    </div>

    <!-- BRANDS TAB -->
    <div class="tab-content" id="tab-brands">
      <h2>üè∑Ô∏è Brand Management</h2>
      <div class="panel">
        <h3>Design a New Brand</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div><label style="font-size:.8rem;color:var(--muted)">Brand Name</label><input type="text" id="brandName" placeholder="e.g. Nova X1" style="width:100%;margin-top:4px"></div>
          <div><label style="font-size:.8rem;color:var(--muted)">Target Segment</label><select id="brandSegment" style="width:100%;margin-top:4px"><option value="Worker">Worker</option><option value="Recreation">Recreation</option><option value="Youth">Youth</option><option value="Mountain">Mountain</option><option value="Speed">Speed</option></select></div>
        </div>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Set component quality (0=None, 1=Basic, 5=Premium). Higher quality increases cost but improves brand appeal.</p>
        <div id="componentSliders"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
          <div><span style="font-size:.85rem;color:var(--muted)">Est. Unit Cost: </span><strong id="estCost">$0</strong></div>
          <button class="btn btn-primary" onclick="createBrand()">Create Brand</button>
        </div>
      </div>
      <div class="panel">
        <h3>Active Brands</h3>
        <div id="brandList"><p style="color:var(--muted);font-size:.85rem">No brands yet. Design your first brand above.</p></div>
      </div>
    </div>

    <!-- PRICING TAB -->
    <div class="tab-content" id="tab-pricing">
      <h2>üí≤ Pricing Strategy</h2>
      <div class="panel">
        <h3>Set Prices Per Brand & Region</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Prices are per unit in USD. Consider segment price sensitivity and competitor pricing.</p>
        <div id="pricingTable"><p style="color:var(--muted);font-size:.85rem">Create brands first to set pricing.</p></div>
      </div>
    </div>

    <!-- ADVERTISING TAB -->
    <div class="tab-content" id="tab-advertising">
      <h2>üì£ Advertising & Marketing</h2>
      <div class="panel">
        <h3>Regional Media Spend</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Allocate quarterly advertising budget per region (in $). Target specific segments with your ads.</p>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Ad Budget</div>
          <input type="number" id="ad_latam" value="0" min="0" step="10000" onchange="updateDecisions()">
          <input type="number" id="ad_europe" value="0" min="0" step="10000" onchange="updateDecisions()">
          <input type="number" id="ad_apac" value="0" min="0" step="10000" onchange="updateDecisions()">
        </div>
        <div style="margin-top:12px">
          <label style="font-size:.8rem;color:var(--muted)">Primary Ad Target Segment</label>
          <select id="adTarget" style="margin-top:4px" onchange="updateDecisions()"><option value="Worker">Worker</option><option value="Recreation">Recreation</option><option value="Youth">Youth</option><option value="Mountain">Mountain</option><option value="Speed">Speed</option></select>
        </div>
      </div>
      <div class="panel">
        <h3>Internet Marketing</h3>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>SEM Budget</div>
          <input type="number" id="sem_latam" value="0" min="0" step="5000" onchange="updateDecisions()">
          <input type="number" id="sem_europe" value="0" min="0" step="5000" onchange="updateDecisions()">
          <input type="number" id="sem_apac" value="0" min="0" step="5000" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- SALES FORCE TAB -->
    <div class="tab-content" id="tab-salesforce">
      <h2>üë• Sales Force Management</h2>
      <div class="panel">
        <h3>Headcount Per Region</h3>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Sales Reps</div>
          <input type="number" id="sf_latam" value="2" min="0" max="50" onchange="updateDecisions()">
          <input type="number" id="sf_europe" value="2" min="0" max="50" onchange="updateDecisions()">
          <input type="number" id="sf_apac" value="1" min="0" max="50" onchange="updateDecisions()">
          <div>Salary ($)</div>
          <input type="number" id="sfsal_latam" value="40000" min="20000" step="5000" onchange="updateDecisions()">
          <input type="number" id="sfsal_europe" value="50000" min="20000" step="5000" onchange="updateDecisions()">
          <input type="number" id="sfsal_apac" value="35000" min="20000" step="5000" onchange="updateDecisions()">
          <div>Commission %</div>
          <input type="number" id="sfcom_latam" value="5" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="sfcom_europe" value="5" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="sfcom_apac" value="5" min="0" max="20" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- DISTRIBUTION TAB -->
    <div class="tab-content" id="tab-distribution">
      <h2>üè™ Distribution Channels</h2>
      <div class="panel">
        <h3>Sales Outlets Per Region</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Each outlet costs ~$50,000/quarter to operate. More outlets = wider reach.</p>
        <div class="region-grid">
          <div class="header"></div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
          <div>Outlets</div>
          <input type="number" id="dist_latam" value="1" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="dist_europe" value="1" min="0" max="20" onchange="updateDecisions()">
          <input type="number" id="dist_apac" value="0" min="0" max="20" onchange="updateDecisions()">
        </div>
      </div>
    </div>

    <!-- PRODUCTION TAB -->
    <div class="tab-content" id="tab-production">
      <h2>üè≠ Production Planning</h2>
      <div class="panel">
        <h3>Units to Produce Per Brand</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Set production quantity for each active brand. Overproduction wastes money; underproduction means lost sales (stockouts).</p>
        <div id="productionTable"><p style="color:var(--muted);font-size:.85rem">Create brands first to plan production.</p></div>
      </div>
    </div>

    <!-- R&D TAB -->
    <div class="tab-content" id="tab-rd">
      <h2>üî¨ Research & Development</h2>
      <div class="panel">
        <h3>R&D Investment</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Invest in R&D to unlock new component improvements. Typical investment: $200K-$1M per quarter.</p>
        <div style="display:flex;gap:12px;align-items:end">
          <div style="flex:1"><label style="font-size:.8rem;color:var(--muted)">R&D Budget This Quarter ($)</label><input type="number" id="rdBudget" value="250000" min="0" step="50000" style="width:100%;margin-top:4px" onchange="updateDecisions()"></div>
        </div>
        <div style="margin-top:12px"><label style="font-size:.8rem;color:var(--muted)">Cumulative R&D Investment:</label> <strong id="rdCumulative">$0</strong></div>
      </div>
      <div class="panel">
        <h3>Dividend to Corporate</h3>
        <p style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Optional: Return profits to corporate HQ.</p>
        <input type="number" id="dividend" value="0" min="0" step="50000" onchange="updateDecisions()">
      </div>
    </div>

    <!-- RESULTS TAB -->
    <div class="tab-content" id="tab-results">
      <h2>üìà Quarterly Results</h2>
      <div id="resultsContent"><p style="color:var(--muted)">Results will appear after the first quarter is processed.</p></div>
    </div>

    <!-- FINANCIALS TAB -->
    <div class="tab-content" id="tab-financials">
      <h2>üí∞ Financial Statements</h2>
      <div id="financialsContent"><p style="color:var(--muted)">Financial data will appear after the first quarter is processed.</p></div>
    </div>

    <!-- MARKET RESEARCH TAB -->
    <div class="tab-content" id="tab-research">
      <h2>üîç Market Research</h2>
      <div id="researchContent"><p style="color:var(--muted)">Market research data will be available after the first quarter.</p></div>
    </div>

    <!-- LEADERBOARD TAB -->
    <div class="tab-content" id="tab-leaderboard">
      <h2>üèÜ Rankings vs AI Competitors</h2>
      <div id="leaderboardContent"><p style="color:var(--muted)">Rankings will appear after your first quarter is processed.</p></div>
    </div>

  </div>
</div>

<div class="submit-bar">
  <div class="status" id="submitStatus">Editing decisions...</div>
  <div style="display:flex;gap:12px;align-items:center">
    <button class="btn btn-outline btn-sm" onclick="saveDecisions()">üíæ Save Draft</button>
    <button class="btn btn-green" onclick="submitDecisions()">‚úÖ Submit Quarter</button>
  </div>
</div>

<script>
const API=window.location.origin;
const gameId=new URLSearchParams(location.search).get('game');
let user=null,game=null,team=null,brands=[],decisions={},results=null;

const COMPONENTS=['frame','wheels','drivetrain','brakes','suspension','seat','handlebars','electronics'];

// Product-specific component labels per scenario
const PRODUCT_LABELS={
  'local-launch':{
    frame:'üèóÔ∏è Build Quality', wheels:'üì± Display', drivetrain:'‚ö° Processor', brakes:'üîã Battery',
    suspension:'üì∏ Camera', seat:'üñ•Ô∏è Software', handlebars:'üíæ Storage', electronics:'üì° Connectivity',
    productName:'Smartphone',
    segments:{Worker:'Budget Buyers',Recreation:'Social Connectors'}
  },
  'mountain-expedition':{
    frame:'üõ°Ô∏è Case Design', wheels:'üì± Display', drivetrain:'‚ù§Ô∏è Sensors', brakes:'üîã Battery Life',
    suspension:'üí™ Durability', seat:'ü§≤ Comfort & Fit', handlebars:'‚ú® Style & Design', electronics:'üì° Connectivity',
    productName:'Wearable',
    segments:{Mountain:'Athletes',Recreation:'Health-Conscious',Speed:'Tech Enthusiasts'}
  },
  'global-domination':{
    frame:'üèóÔ∏è Build Quality', wheels:'üñ•Ô∏è Display', drivetrain:'‚ö° Processor', brakes:'üîã Battery',
    suspension:'üéÆ Graphics Card', seat:'‚å®Ô∏è Keyboard', handlebars:'üíæ Storage', electronics:'üì° Connectivity',
    productName:'Laptop',
    segments:{Worker:'Business Pros',Recreation:'Students',Youth:'Casual Users',Mountain:'Creative Pros',Speed:'Gamers'}
  },
  'speed-innovation':{
    frame:'üõ°Ô∏è Build Quality', wheels:'üëÅÔ∏è Display / Optics', drivetrain:'‚ö° Processor', brakes:'üéØ Motion Tracking',
    suspension:'üîä Audio System', seat:'ü§≤ Comfort', handlebars:'üéÆ Software / Content', electronics:'üì° Connectivity',
    productName:'VR Headset',
    segments:{Speed:'Hardcore Gamers',Youth:'Casual Gamers'}
  }
};

// Fallback labels
const DEFAULT_LABELS={frame:'üèóÔ∏è Component 1',wheels:'üîµ Component 2',drivetrain:'‚öôÔ∏è Component 3',brakes:'üõë Component 4',suspension:'üîß Component 5',seat:'üí∫ Component 6',handlebars:'üéØ Component 7',electronics:'üí° Component 8',productName:'Product',segments:{Worker:'Worker',Recreation:'Recreation',Youth:'Youth',Mountain:'Mountain',Speed:'Speed'}};

function getComponentLabels(scenario){return PRODUCT_LABELS[scenario]||DEFAULT_LABELS;}
let COMPONENT_LABELS=DEFAULT_LABELS;
const REGIONS=['LATAM','Europe','APAC'];

async function apiFetch(url,opts={}){
  const token=localStorage.getItem('token');
  const headers={'Content-Type':'application/json'};
  if(token)headers['Authorization']='Bearer '+token;
  try{
    const res=await fetch(API+url,{...opts,headers});
    const text=await res.text();
    try{return JSON.parse(text)}catch(e){console.error('Non-JSON from '+url+':',text);return{error:'Server error'}}
  }catch(e){console.error('Network error for '+url+':',e);return{error:'Network error'}}
}

// Init component sliders
function initSliders(){
  const container=document.getElementById('componentSliders');
  container.innerHTML=COMPONENTS.map(c=>`
    <div class="component-row">
      <div class="component-label">${COMPONENT_LABELS[c]}</div>
      <div class="component-slider">
        <input type="range" min="0" max="5" value="3" id="comp_${c}" oninput="document.getElementById('compval_${c}').textContent=this.value;updateEstCost()">
        <div class="val" id="compval_${c}">3</div>
      </div>
    </div>
  `).join('');
}

function updateEstCost(){
  let cost=50;
  COMPONENTS.forEach(c=>{const v=parseInt(document.getElementById('comp_'+c).value);cost+=v*v*8+v*15});
  document.getElementById('estCost').textContent='$'+cost.toLocaleString();
}

// Tab navigation
document.querySelectorAll('.sidebar-item').forEach(item=>{
  item.addEventListener('click',()=>{
    document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+item.dataset.tab).classList.add('active');
  });
});

async function init(){
  if(!gameId)return window.location.href='/dashboard.html';
  const authData=await apiFetch('/api/auth/me');
  if(!authData.user)return window.location.href='/index.html';
  user=authData.user;

  const gameData=await apiFetch('/api/game/details?game_id='+gameId);
  if(gameData.error)return alert(gameData.error);
  game=gameData.game;
  team=gameData.team;
  brands=gameData.brands||[];
  // Set product-specific component labels based on scenario
  COMPONENT_LABELS=getComponentLabels(game.market_scenario);
  // Update segment dropdowns with product-specific names
  const segLabels=COMPONENT_LABELS.segments||{};
  ['brandSegment','adTarget'].forEach(id=>{
    const sel=document.getElementById(id);
    if(!sel)return;
    sel.innerHTML='';
    Object.keys(segLabels).forEach(key=>{
      const opt=document.createElement('option');
      opt.value=key;
      opt.textContent=segLabels[key];
      sel.appendChild(opt);
    });
  });

  document.getElementById('gameName').textContent=game.name||'Simulation';
  document.getElementById('quarterBadge').textContent='Q'+game.current_quarter;
  document.getElementById('submitQ').textContent=game.current_quarter||1;
  if(team){
    document.getElementById('teamName').textContent=(team.logo_emoji||'üè¢')+' '+(team.name||'My Company');
    document.getElementById('cashDisplay').textContent='$'+Number(team.cash_balance||5000000).toLocaleString();
  }

  // Instructor panel removed ‚Äî using preset scenarios only

  initSliders();
  updateEstCost();
  loadDecisions();
  loadBrandList();
  loadResults();
  loadLeaderboard();
  loadResearch();
}

function loadBrandList(){
  const container=document.getElementById('brandList');
  if(!brands.length){container.innerHTML='<p style="color:var(--muted);font-size:.85rem">No brands yet.</p>';return}
  container.innerHTML=`<table><thead><tr><th>Brand</th><th>Segment</th><th>Quality</th><th>Unit Cost</th><th>Status</th></tr></thead><tbody>${
    brands.map(b=>{const segName=(COMPONENT_LABELS.segments||{})[b.target_segment]||b.target_segment;return `<tr><td><strong>${esc(b.name)}</strong></td><td>${segName}</td><td>${(b.overall_quality||0).toFixed(1)}</td><td>$${Number(b.unit_cost||0).toLocaleString()}</td><td>${b.is_active?'<span style="color:var(--green)">Active</span>':'<span style="color:var(--muted)">Inactive</span>'}</td></tr>`}).join('')
  }</tbody></table>`;
  updatePricingTable();
  updateProductionTable();
}

function updatePricingTable(){
  if(!brands.length)return;
  const container=document.getElementById('pricingTable');
  container.innerHTML=`<div class="region-grid" style="grid-template-columns:150px repeat(3,1fr)">
    <div class="header">Brand</div><div class="header">LATAM</div><div class="header">Europe</div><div class="header">APAC</div>
    ${brands.filter(b=>b.is_active).map(b=>`
      <div>${esc(b.name)}</div>
      ${REGIONS.map(r=>`<input type="number" id="price_${b.id}_${r}" value="${getDecisionPrice(b.id,r)}" min="200" max="3000" step="10" onchange="updateDecisions()">`).join('')}
    `).join('')}
  </div>`;
}

function updateProductionTable(){
  if(!brands.length)return;
  const container=document.getElementById('productionTable');
  container.innerHTML=`<table><thead><tr><th>Brand</th><th>Units to Produce</th><th>Est. Cost/Unit</th><th>Total Cost</th></tr></thead><tbody>${
    brands.filter(b=>b.is_active).map(b=>`<tr>
      <td><strong>${esc(b.name)}</strong></td>
      <td><input type="number" id="prod_${b.id}" value="${getDecisionProd(b.id)}" min="0" max="50000" step="100" onchange="updateDecisions()" style="width:120px"></td>
      <td>$${Number(b.unit_cost||0).toLocaleString()}</td>
      <td id="prodtotal_${b.id}">$0</td>
    </tr>`).join('')
  }</tbody></table>`;
}

function getDecisionPrice(brandId,region){return decisions?.pricing?.[brandId]?.[region]||900}
function getDecisionProd(brandId){return decisions?.production?.[brandId]||500}

function collectDecisions(){
  const d={pricing:{},advertising:{},internet_marketing:{},salesforce:{},distribution:{},rd_budget:parseInt(document.getElementById('rdBudget').value)||0,production:{},dividend:parseInt(document.getElementById('dividend').value)||0};
  brands.filter(b=>b.is_active).forEach(b=>{
    d.pricing[b.id]={};d.production[b.id]=parseInt(document.getElementById('prod_'+b.id)?.value)||0;
    REGIONS.forEach(r=>{d.pricing[b.id][r]=parseInt(document.getElementById(`price_${b.id}_${r}`)?.value)||900});
  });
  d.advertising={latam:parseInt(document.getElementById('ad_latam').value)||0,europe:parseInt(document.getElementById('ad_europe').value)||0,apac:parseInt(document.getElementById('ad_apac').value)||0,target:document.getElementById('adTarget').value};
  d.internet_marketing={latam:parseInt(document.getElementById('sem_latam').value)||0,europe:parseInt(document.getElementById('sem_europe').value)||0,apac:parseInt(document.getElementById('sem_apac').value)||0};
  d.salesforce={};
  REGIONS.forEach(r=>{const rl=r.toLowerCase();d.salesforce[rl]={count:parseInt(document.getElementById('sf_'+rl).value)||0,salary:parseInt(document.getElementById('sfsal_'+rl).value)||0,commission:parseInt(document.getElementById('sfcom_'+rl).value)||0}});
  d.distribution={latam:parseInt(document.getElementById('dist_latam').value)||0,europe:parseInt(document.getElementById('dist_europe').value)||0,apac:parseInt(document.getElementById('dist_apac').value)||0};
  return d;
}

function updateDecisions(){decisions=collectDecisions()}

async function saveDecisions(){
  decisions=collectDecisions();
  const data=await apiFetch('/api/simulation/submit-decisions',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team?.id,quarter:game.current_quarter,decisions,submit:false})});
  if(data.error)return alert(data.error);
  document.getElementById('submitStatus').textContent='üíæ Draft saved';
}

async function submitDecisions(){
  if(!confirm('Submit your decisions for Q'+(game.current_quarter||1)+'? The quarter will process immediately.'))return;
  decisions=collectDecisions();
  var btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent='‚è≥ Processing...';
  document.getElementById('submitStatus').textContent='Processing quarter...';
  const data=await apiFetch('/api/simulation/submit-decisions',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team?.id,quarter:game.current_quarter,decisions,submit:true})});
  if(data.code==='PAYWALL'){btn.disabled=false;btn.textContent='Submit Q'+(game.current_quarter||1);showPaywall(data);return;}
  if(data.error){btn.disabled=false;btn.textContent='Submit Q'+(game.current_quarter||1);return alert(data.error);}

  // Quarter processed! Show results summary
  var r=data.results;
  if(r){
    var rank=1;
    if(data.leaderboard){data.leaderboard.forEach(function(t,i){if(t.isPlayer)rank=i+1});}
    alert('‚úÖ Q'+(data.quarterProcessed)+' Results!\n\n'+
      'üí∞ Revenue: $'+Number(r.revenue||0).toLocaleString()+'\n'+
      'üìä Net Income: $'+Number(r.netIncome||0).toLocaleString()+'\n'+
      'üìà Market Share: '+((r.marketShare||0)*100).toFixed(1)+'%\n'+
      'üèÜ Scorecard: '+(r.balancedScorecard||0).toFixed(2)+'\n'+
      'ü•á Rank: #'+rank+' of '+(data.leaderboard?.length||1)+'\n\n'+
      (data.gameCompleted?'üéâ Simulation complete!':'Next: Q'+data.nextQuarter));
  }
  // Reload to show new quarter
  location.reload();
}

function showPaywall(data){
  document.getElementById('paywallUsed').textContent=data.decisionsUsed||3;
  document.getElementById('paywallLimit').textContent=data.limit||3;
  document.getElementById('paywallModal').style.display='flex';
}
function closePaywall(){document.getElementById('paywallModal').style.display='none';}

async function createBrand(){
  const name=document.getElementById('brandName').value.trim();
  const segment=document.getElementById('brandSegment').value;
  if(!name)return alert('Please enter a brand name');
  const components={};
  COMPONENTS.forEach(c=>components[c]=parseInt(document.getElementById('comp_'+c).value));
  const data=await apiFetch('/api/team/brands',{method:'POST',body:JSON.stringify({game_id:gameId,team_id:team?.id,name,target_segment:segment,components})});
  if(data.error)return alert(data.error);
  brands.push(data.brand);
  document.getElementById('brandName').value='';
  loadBrandList();
}

async function loadDecisions(){
  if(!team||!game.current_quarter)return;
  const data=await apiFetch(`/api/simulation/get-decisions?game_id=${gameId}&team_id=${team.id}&quarter=${game.current_quarter}`);
  if(data.decisions){
    decisions=data.decisions;
    // Populate fields from saved decisions
    if(decisions.advertising){
      ['latam','europe','apac'].forEach(r=>{if(document.getElementById('ad_'+r))document.getElementById('ad_'+r).value=decisions.advertising[r]||0});
      if(decisions.advertising.target)document.getElementById('adTarget').value=decisions.advertising.target;
    }
    if(decisions.internet_marketing){['latam','europe','apac'].forEach(r=>{if(document.getElementById('sem_'+r))document.getElementById('sem_'+r).value=decisions.internet_marketing[r]||0})}
    if(decisions.salesforce){REGIONS.forEach(r=>{const rl=r.toLowerCase();const sf=decisions.salesforce[rl]||{};if(document.getElementById('sf_'+rl)){document.getElementById('sf_'+rl).value=sf.count||0;document.getElementById('sfsal_'+rl).value=sf.salary||40000;document.getElementById('sfcom_'+rl).value=sf.commission||5}})}
    if(decisions.distribution){['latam','europe','apac'].forEach(r=>{if(document.getElementById('dist_'+r))document.getElementById('dist_'+r).value=decisions.distribution[r]||0})}
    if(decisions.rd_budget)document.getElementById('rdBudget').value=decisions.rd_budget;
    if(decisions.dividend)document.getElementById('dividend').value=decisions.dividend;
  }
}

async function loadResults(){
  if(!team||game.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/get-results?game_id=${gameId}&team_id=${team.id}&quarter=${game.current_quarter-1}`);
  if(!data.results)return;
  results=data.results;
  const r=results;
  document.getElementById('ovCash').textContent='$'+Number(r.ending_cash||0).toLocaleString();
  document.getElementById('ovRevenue').textContent='$'+Number(r.revenue||0).toLocaleString();
  document.getElementById('ovIncome').textContent='$'+Number(r.net_income||0).toLocaleString();
  document.getElementById('ovIncome').className='stat-value '+((r.net_income||0)>=0?'positive':'negative');
  document.getElementById('ovShare').textContent=((r.market_share||0)*100).toFixed(1)+'%';
  document.getElementById('ovDemand').textContent=Number(r.total_demand||0).toLocaleString();
  document.getElementById('ovBSC').textContent=(r.balanced_scorecard||0).toFixed(2);

  // Results tab
  document.getElementById('resultsContent').innerHTML=`
    <div class="scorecard-bar">
      <div class="sc-item sc-total"><div class="label">Total Score</div><div class="score">${(r.balanced_scorecard||0).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Financial</div><div class="score">${(r.financial_performance||0).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Market</div><div class="score">${(r.market_performance||0).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Mktg Effect.</div><div class="score">${(r.marketing_effectiveness||0).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Investment</div><div class="score">${(r.investment_future||0).toFixed(2)}</div></div>
      <div class="sc-item"><div class="label">Wealth</div><div class="score">${(r.wealth_creation||0).toFixed(2)}</div></div>
    </div>
    <div class="panel"><h3>Q${game.current_quarter-1} Performance</h3>
      <div class="panel-grid">
        <div class="stat-card"><div class="stat-label">Revenue</div><div class="stat-value">$${Number(r.revenue||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">COGS</div><div class="stat-value">$${Number(r.total_cogs||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Expenses</div><div class="stat-value">$${Number(r.total_expenses||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Net Income</div><div class="stat-value ${(r.net_income||0)>=0?'positive':'negative'}">$${Number(r.net_income||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Units Sold</div><div class="stat-value">${Number(r.units_sold||0).toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">Stockouts</div><div class="stat-value ${(r.stockouts||0)>0?'negative':''}">${r.stockouts||0}</div></div>
      </div>
    </div>`;

  // Financials tab
  document.getElementById('financialsContent').innerHTML=`
    <div class="panel"><h3>Income Statement ‚Äî Q${game.current_quarter-1}</h3>
      <table><tbody>
        <tr><td>Revenue</td><td style="text-align:right">$${N(r.revenue)}</td></tr>
        <tr><td>Cost of Goods Sold</td><td style="text-align:right">($${N(r.total_cogs)})</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Gross Profit</td><td style="text-align:right">$${N((r.revenue||0)-(r.total_cogs||0))}</td></tr>
        <tr><td>Operating Expenses</td><td style="text-align:right">($${N(r.total_expenses)})</td></tr>
        <tr style="font-weight:700;border-top:2px solid var(--border)"><td>Net Income</td><td style="text-align:right;color:${(r.net_income||0)>=0?'var(--green)':'var(--red)'}">$${N(r.net_income)}</td></tr>
      </tbody></table>
    </div>
    <div class="panel"><h3>Cash Flow</h3>
      <table><tbody>
        <tr><td>Starting Cash</td><td style="text-align:right">$${N(r.starting_cash)}</td></tr>
        <tr><td>Cash from Operations</td><td style="text-align:right">$${N(r.cash_from_operations)}</td></tr>
        <tr style="font-weight:700"><td>Ending Cash</td><td style="text-align:right;color:var(--green)">$${N(r.ending_cash)}</td></tr>
      </tbody></table>
    </div>`;
}

async function loadLeaderboard(){
  if(game?.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/leaderboard?game_id=${gameId}`);
  if(!data.leaderboard)return;
  const container=document.getElementById('leaderboardContent');
  container.innerHTML=data.leaderboard.map(function(t,i){
    var rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
    var isYou=t.is_player||t.isPlayer;
    return '<div class="lb-row" style="'+(isYou?'background:rgba(59,130,246,.08);border:1px solid var(--primary);border-radius:8px;padding:8px 12px':'')+'"><div class="lb-rank '+rankClass+'">#'+(i+1)+'</div><div class="lb-name">'+(t.logo_emoji||'üè¢')+' '+esc(t.name)+(isYou?' <span style="color:var(--primary);font-size:.75rem">YOU</span>':'<span style="color:var(--muted);font-size:.75rem"> ü§ñ AI</span>')+'</div><div class="lb-score">'+(t.cumulative_scorecard||t.balanced_scorecard||0).toFixed(2)+'</div></div>';
  }).join('');
}

async function loadResearch(){
  if(!team||game?.current_quarter<2)return;
  const data=await apiFetch(`/api/simulation/market-research?game_id=${gameId}&quarter=${game.current_quarter-1}`);
  if(!data.research)return;
  const r=data.research;
  document.getElementById('researchContent').innerHTML=`
    <div class="panel"><h3>Segment Demand ‚Äî Q${game.current_quarter-1}</h3>
      <p style="color:var(--muted);font-size:.85rem">${JSON.stringify(r.segment_demands||{},null,2).replace(/\n/g,'<br>').replace(/ /g,'&nbsp;')}</p>
    </div>
    <div class="panel"><h3>Market Trends</h3>
      <p style="color:var(--muted);font-size:.85rem">${JSON.stringify(r.market_trends||{},null,2).replace(/\n/g,'<br>').replace(/ /g,'&nbsp;')}</p>
    </div>`;
}

function N(v){return Number(v||0).toLocaleString()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

init();
</script>
<!-- Paywall Modal -->
<div id="paywallModal" class="paywall-overlay" style="display:none">
  <div class="paywall-box">
    <div class="paywall-header">
      <div class="pw-icon">üîí</div>
      <h2>Free Preview Complete!</h2>
      <p>You've used <span id="paywallUsed">3</span> of <span id="paywallLimit">3</span> free decisions</p>
    </div>
    <div class="paywall-progress">
      <div class="pw-bar"><div class="pw-bar-fill" style="width:37.5%"></div></div>
      <div class="pw-labels"><span>Q3 of 8</span><span class="locked">üîí Q4‚ÄìQ8 locked</span></div>
    </div>
    <div class="paywall-benefits">
      <h3>Upgrade to unlock:</h3>
      <ul>
        <li>Complete all 8 quarters</li>
        <li>All 4 industry scenarios</li>
        <li>Unlimited decisions</li>
        <li>Detailed analytics & leaderboard</li>
        <li>Priority support</li>
      </ul>
    </div>
    <div class="paywall-pricing">
      <div class="pw-price-card" onclick="location.href='/pricing.html'">
        <div class="pw-amt">$19</div>
        <div class="pw-per">/month</div>
        <div class="pw-tag">Cancel anytime</div>
      </div>
      <div class="pw-price-card" onclick="location.href='/pricing.html'">
        <div class="pw-amt">$149</div>
        <div class="pw-per">one-time</div>
        <div class="pw-tag">üî• Best value</div>
      </div>
    </div>
    <div class="paywall-actions">
      <button class="pw-btn-upgrade" onclick="location.href='/pricing.html'">üöÄ Upgrade to Pro</button>
      <button class="pw-btn-later" onclick="closePaywall()">Maybe later</button>
    </div>
  </div>
</div>

<!-- ===== GUIDED TOUR ===== -->
<div id="tourOverlay" style="display:none">
  <div id="tourBackdrop"></div>
  <div id="tourPopup">
    <div id="tourHeader">
      <span id="tourStep">Step 1 of 8</span>
      <button id="tourClose" onclick="closeTour()">‚úï</button>
    </div>
    <div id="tourIcon"></div>
    <h3 id="tourTitle"></h3>
    <p id="tourDesc"></p>
    <div id="tourTip"></div>
    <div id="tourFooter">
      <button id="tourPrev" onclick="tourNav(-1)">‚Üê Back</button>
      <div id="tourDots"></div>
      <button id="tourNext" onclick="tourNav(1)">Next ‚Üí</button>
    </div>
  </div>
</div>

<style>
#tourBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9998;backdrop-filter:blur(2px)}
#tourPopup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1f36,#0f172a);border:1px solid rgba(99,102,241,.4);border-radius:20px;padding:32px;max-width:480px;width:92%;z-index:9999;box-shadow:0 25px 60px rgba(0,0,0,.5),0 0 40px rgba(99,102,241,.15);animation:tourIn .3s ease}
@keyframes tourIn{from{opacity:0;transform:translate(-50%,-50%) scale(.92)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
#tourHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
#tourStep{font-size:.75rem;color:#818cf8;font-weight:600;text-transform:uppercase;letter-spacing:1px}
#tourClose{background:none;border:none;color:#64748b;font-size:1.2rem;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .15s}
#tourClose:hover{background:rgba(255,255,255,.1);color:white}
#tourIcon{font-size:3rem;margin-bottom:12px}
#tourTitle{color:white;font-size:1.35rem;margin:0 0 10px;font-weight:700}
#tourDesc{color:#94a3b8;font-size:.95rem;line-height:1.6;margin:0 0 16px}
#tourTip{background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.25);border-radius:10px;padding:12px 16px;font-size:.85rem;color:#a5b4fc;margin-bottom:20px;display:none}
#tourTip::before{content:'üí° ';font-size:1rem}
#tourFooter{display:flex;justify-content:space-between;align-items:center;gap:12px}
#tourDots{display:flex;gap:6px}
.tour-dot{width:8px;height:8px;border-radius:50%;background:#334155;transition:all .2s}
.tour-dot.active{background:#6366f1;transform:scale(1.3)}
.tour-dot.done{background:#4f46e5}
#tourPrev,#tourNext{background:none;border:1px solid #334155;color:#94a3b8;padding:8px 18px;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:500;transition:all .15s}
#tourPrev:hover,#tourNext:hover{border-color:#6366f1;color:white}
#tourNext{background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;color:white}
#tourNext:hover{opacity:.9}
#tourPrev:disabled{opacity:.3;pointer-events:none}
#tourHelpBtn{position:fixed;bottom:24px;right:24px;z-index:100;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;width:48px;height:48px;border-radius:50%;font-size:1.3rem;cursor:pointer;box-shadow:0 4px 15px rgba(99,102,241,.4);transition:all .2s;display:flex;align-items:center;justify-content:center}
#tourHelpBtn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(99,102,241,.5)}
</style>

<!-- Floating help button -->
<button id="tourHelpBtn" onclick="startTour()" title="Guided Tour">‚ùì</button>

<script>
const TOUR_STEPS=[
  {
    icon:'üéØ',
    title:'Welcome to Your Simulation!',
    desc:'You\'re the marketing director of a tech company. Each quarter, you\'ll make strategic decisions ‚Äî then see how you perform against AI competitors.',
    tip:'This simulation has 8 quarters. Each quarter, you\'ll go through these tabs from left to right, then submit.',
    tab:null
  },
  {
    icon:'üè∑Ô∏è',
    title:'Step 1: Create Your Brand',
    desc:'Start by designing a product. Give it a name, pick a target customer segment, and set the quality of each component using the sliders.',
    tip:'Higher quality = better appeal but higher cost. Find the sweet spot for your target segment.',
    tab:'brands'
  },
  {
    icon:'üí≤',
    title:'Step 2: Set Your Prices',
    desc:'Set a price for each of your brands in each region you operate in. Pricing affects demand, revenue, and how customers perceive your product.',
    tip:'Check your unit cost first ‚Äî price above it to make profit. Different segments have different price sensitivities.',
    tab:'pricing'
  },
  {
    icon:'üì£',
    title:'Step 3: Advertising',
    desc:'Allocate your advertising budget across regions. More spend = more awareness, but diminishing returns kick in at high levels.',
    tip:'Focus your ad budget on regions and segments where you have the strongest products.',
    tab:'advertising'
  },
  {
    icon:'üë•',
    title:'Step 4: Sales Force',
    desc:'Hire salespeople in each region and set their compensation. More reps and better pay = more sales coverage.',
    tip:'Salespeople take a quarter to become fully effective. Hire early and maintain your team.',
    tab:'salesforce'
  },
  {
    icon:'üè™',
    title:'Step 5: Distribution',
    desc:'Choose distribution channels and allocate support budget per region. This determines where customers can buy your product.',
    tip:'Different segments shop in different channels. Match your distribution to your target customers.',
    tab:'distribution'
  },
  {
    icon:'üè≠',
    title:'Step 6: Production',
    desc:'Decide how many units to produce for each brand. Too few = stockouts and missed sales. Too many = excess inventory costs.',
    tip:'Look at last quarter\'s demand to estimate this quarter. Growing markets need more units each quarter.',
    tab:'production'
  },
  {
    icon:'üî¨',
    title:'Step 7: R&D Investment',
    desc:'Invest in research to improve your product quality over time. R&D pays off in future quarters with better components.',
    tip:'R&D is a long-term play. Early investment compounds. Don\'t neglect it.',
    tab:'rd'
  },
  {
    icon:'üöÄ',
    title:'Ready to Submit!',
    desc:'Once you\'ve made all your decisions, hit the Submit button at the bottom. The engine will process your quarter against the AI competitors and show you the results.',
    tip:'After submitting, check the Results, Financials, and Rankings tabs to see how you performed. Then start the next quarter!',
    tab:'overview'
  }
];

let tourCurrent=0;

function startTour(){
  tourCurrent=0;
  document.getElementById('tourOverlay').style.display='block';
  renderTourStep();
}

function closeTour(){
  document.getElementById('tourOverlay').style.display='none';
  try{localStorage.setItem('marketsim_tour_seen','1')}catch(e){}
}

function tourNav(dir){
  tourCurrent+=dir;
  if(tourCurrent>=TOUR_STEPS.length){closeTour();return}
  if(tourCurrent<0)tourCurrent=0;
  renderTourStep();
}

function renderTourStep(){
  const s=TOUR_STEPS[tourCurrent];
  document.getElementById('tourStep')
    .textContent=tourCurrent===0?'Welcome':`Step ${tourCurrent} of ${TOUR_STEPS.length-1}`;
  document.getElementById('tourIcon').textContent=s.icon;
  document.getElementById('tourTitle').textContent=s.title;
  document.getElementById('tourDesc').textContent=s.desc;

  const tipEl=document.getElementById('tourTip');
  if(s.tip){tipEl.textContent=s.tip;tipEl.style.display='block'}
  else{tipEl.style.display='none'}

  // Navigate to tab
  if(s.tab){
    document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    const tabItem=document.querySelector(`.sidebar-item[data-tab="${s.tab}"]`);
    if(tabItem)tabItem.classList.add('active');
    const tabContent=document.getElementById('tab-'+s.tab);
    if(tabContent)tabContent.classList.add('active');
  }

  // Dots
  const dotsEl=document.getElementById('tourDots');
  dotsEl.innerHTML=TOUR_STEPS.map((_,i)=>
    `<div class="tour-dot ${i===tourCurrent?'active':i<tourCurrent?'done':''}"></div>`
  ).join('');

  // Buttons
  document.getElementById('tourPrev').disabled=tourCurrent===0;
  document.getElementById('tourNext').textContent=
    tourCurrent===TOUR_STEPS.length-1?'Let\'s Go! üöÄ':'Next ‚Üí';
}

// Auto-show tour on first Q1 visit
(function(){
  const origInit=window._tourInitHook;
  const checkTour=()=>{
    try{
      if(localStorage.getItem('marketsim_tour_seen'))return;
    }catch(e){}
    // Show after a short delay so the page loads
    setTimeout(()=>{
      if(game && game.current_quarter<=1)startTour();
    },800);
  };
  // Hook into the existing init completion
  const origOnload=window.onload;
  window.addEventListener('load',()=>setTimeout(checkTour,1200));
})();
</script>

</body>
</html>
