<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî MarketSim Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#111827;--border:#1e293b;--primary:#3b82f6;--primary-hover:#2563eb;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#e2e8f0;--muted:#94a3b8;--surface:#1e293b}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

nav{display:flex;justify-content:space-between;align-items:center;padding:16px 40px;border-bottom:1px solid var(--border);background:rgba(10,14,26,.95)}
.logo{font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
.nav-user{display:flex;align-items:center;gap:10px}
.nav-user span{color:var(--muted);font-size:.9rem}
.btn{padding:10px 24px;border-radius:8px;border:none;font-weight:600;font-size:.9rem;transition:all .2s;cursor:pointer;font-family:inherit}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary);background:rgba(59,130,246,.1)}
.btn-sm{padding:6px 16px;font-size:.82rem}

.container{max-width:1200px;margin:0 auto;padding:32px 40px}
h1{font-size:1.8rem;margin-bottom:4px}
.subtitle{color:var(--muted);margin-bottom:32px;font-size:.95rem}

.section-title{font-size:1.2rem;font-weight:600;margin:0 0 20px;display:flex;align-items:center;gap:8px}
.scenarios-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:48px}

.scenario-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:0;overflow:hidden;transition:all .3s;display:flex;flex-direction:column}
.scenario-card:hover{border-color:var(--primary);box-shadow:0 8px 30px rgba(59,130,246,.1);transform:translateY(-2px)}
.scenario-header{padding:28px 24px 20px;text-align:center}
.scenario-icon{font-size:2.8rem;margin-bottom:12px;display:block}
.scenario-name{font-size:1.2rem;font-weight:700;margin-bottom:4px}
.scenario-tagline{color:var(--muted);font-size:.85rem;font-style:italic}
.difficulty-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-top:10px}

.scenario-body{padding:0 24px 12px;flex:1}
.scenario-desc{color:var(--muted);font-size:.85rem;line-height:1.5;margin-bottom:16px}
.scenario-details{display:flex;flex-wrap:wrap;gap:6px}
.detail-tag{padding:3px 10px;border-radius:6px;font-size:.75rem;background:var(--surface);color:var(--muted);border:1px solid var(--border)}

.scenario-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.player-count{font-size:.82rem;color:var(--muted)}
.play-btn{padding:10px 28px;border-radius:10px;border:none;font-weight:700;font-size:.9rem;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--primary),var(--accent));transition:all .2s;font-family:inherit}
.play-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(59,130,246,.3)}
.play-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px;margin-bottom:40px}
.game-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px;transition:all .3s;cursor:pointer;text-decoration:none;color:inherit;display:block}
.game-card:hover{border-color:var(--primary);box-shadow:0 4px 20px rgba(59,130,246,.08)}
.game-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:12px}
.game-name{font-size:1.1rem;font-weight:600}
.game-status{padding:4px 10px;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase}
.status-lobby{background:rgba(245,158,11,.15);color:var(--yellow)}
.status-active{background:rgba(16,185,129,.15);color:var(--green)}
.status-completed{background:rgba(148,163,184,.15);color:var(--muted)}
.game-meta{color:var(--muted);font-size:.85rem;display:flex;flex-direction:column;gap:6px}
.game-footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)}
.quarter-display{font-size:.85rem;color:var(--muted)}
.quarter-display strong{color:var(--primary);font-size:1rem}
.continue-btn{padding:6px 18px;border-radius:8px;border:none;font-weight:600;font-size:.82rem;cursor:pointer;color:#fff;background:var(--green);font-family:inherit}

.empty-state{text-align:center;padding:40px;color:var(--muted);background:var(--card);border:1px solid var(--border);border-radius:14px}
.empty-state .icon{font-size:2.5rem;margin-bottom:12px}
.empty-state h3{color:var(--text);margin-bottom:6px}

@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}

@media(max-width:768px){
  nav{padding:12px 20px}
  .container{padding:24px 20px}
  .scenarios-grid{grid-template-columns:1fr}
  .games-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<nav>
  <a href="/index.html" class="logo">üö¥ MarketSim Live</a>
  <div class="nav-user">
    <span id="userName"></span>
    <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container">
  <h1 id="greeting">Dashboard</h1>
  <p class="subtitle">Choose a scenario and start competing. Each game matches you with other players automatically.</p>

  <div class="section-title">üéØ Choose a Scenario</div>
  <div class="scenarios-grid" id="scenariosList">
    <div style="color:var(--muted);padding:40px;text-align:center">Loading scenarios...</div>
  </div>

  <div class="section-title">üìã My Active Games</div>
  <div id="gamesList" class="games-grid"></div>
  <div id="emptyState" class="empty-state" style="display:none">
    <div class="icon">üéÆ</div>
    <h3>No games yet</h3>
    <p>Pick a scenario above to start your first game!</p>
  </div>
</div>

<script>
const API = window.location.origin;
let user = null;

async function apiFetch(url, opts = {}) {
  const token = localStorage.getItem('token');
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  try {
    const res = await fetch(API + url, { ...opts, headers });
    const text = await res.text();
    try { return JSON.parse(text); } catch(e) { console.error('Non-JSON from ' + url + ':', text); return { error: 'Server error' }; }
  } catch(e) { console.error('Network error for ' + url + ':', e); return { error: 'Network error' }; }
}

function logout() {
  localStorage.removeItem('token');
  window.location.href = '/index.html';
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function init() {
  const data = await apiFetch('/api/auth/me');
  if (!data.user) return window.location.href = '/index.html';
  user = data.user;
  document.getElementById('userName').textContent = user.name;
  document.getElementById('greeting').textContent = 'Welcome back, ' + user.name.split(' ')[0] + '!';
  loadScenarios();
  loadGames();
}

async function loadScenarios() {
  const data = await apiFetch('/api/game/quick-join');
  const scenarios = data.scenarios || [];
  const container = document.getElementById('scenariosList');

  if (!scenarios.length) {
    container.innerHTML = '<div style="color:var(--muted);padding:20px">No scenarios available.</div>';
    return;
  }

  container.innerHTML = scenarios.map(function(s) {
    return '<div class="scenario-card" id="card-' + s.id + '">' +
      '<div class="scenario-header">' +
        '<span class="scenario-icon">' + s.icon + '</span>' +
        '<div class="scenario-name">' + esc(s.name) + '</div>' +
        '<div class="scenario-tagline">' + esc(s.tagline) + '</div>' +
        '<span class="difficulty-badge" style="background:' + s.difficultyColor + '22;color:' + s.difficultyColor + '">' + s.difficulty + '</span>' +
      '</div>' +
      '<div class="scenario-body">' +
        '<div class="scenario-desc">' + esc(s.description) + '</div>' +
        '<div class="scenario-details">' +
          s.regions.map(function(r) { return '<span class="detail-tag">üåé ' + r + '</span>'; }).join('') +
          s.segments.map(function(seg) { return '<span class="detail-tag">üë§ ' + seg + '</span>'; }).join('') +
          '<span class="detail-tag">üë• ' + s.maxTeams + ' teams</span>' +
        '</div>' +
      '</div>' +
      '<div class="scenario-footer">' +
        '<span class="player-count" id="count-' + s.id + '"></span>' +
        '<button class="play-btn" id="btn-' + s.id + '" onclick="joinScenario(\'' + s.id + '\')">üìã View Brief</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function joinScenario(scenarioId) {
  window.location.href = '/briefing.html?scenario=' + scenarioId;
}

async function loadGames() {
  var data = await apiFetch('/api/game/list');
  var games = data.games || [];
  var container = document.getElementById('gamesList');

  if (!games.length) {
    container.innerHTML = '';
    document.getElementById('emptyState').style.display = '';
    return;
  }

  document.getElementById('emptyState').style.display = 'none';
  container.innerHTML = games.map(function(g) {
    var statusClass = g.status === 'lobby' ? 'status-lobby' : g.status === 'active' ? 'status-active' : 'status-completed';
    var qLabel = g.current_quarter === 0 ? 'Lobby' : 'Q' + g.current_quarter + '/8';
    var scenarioName = g.market_scenario ? g.market_scenario.replace(/-/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }) : 'Standard';
    return '<a class="game-card" href="/simulation.html?game=' + g.id + '">' +
      '<div class="game-header">' +
        '<div class="game-name">' + esc(g.name || 'Game') + '</div>' +
        '<span class="game-status ' + statusClass + '">' + g.status + '</span>' +
      '</div>' +
      '<div class="game-meta">' +
        '<span>üéØ ' + scenarioName + '</span>' +
        '<span>üë• ' + (g.team_count || 0) + ' team' + (g.team_count !== 1 ? 's' : '') + '</span>' +
        (g.team_name ? '<span>üè∑Ô∏è My Team: ' + esc(g.team_name) + '</span>' : '') +
      '</div>' +
      '<div class="game-footer">' +
        '<div class="quarter-display">Quarter: <strong>' + qLabel + '</strong></div>' +
        '<span class="continue-btn">Continue ‚Üí</span>' +
      '</div>' +
    '</a>';
  }).join('');
}

init();
</script>
</body>
</html>
