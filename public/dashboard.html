<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî MarketSim Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--card:#111827;--border:#1e293b;--primary:#3b82f6;--primary-hover:#2563eb;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--text:#e2e8f0;--muted:#94a3b8;--surface:#1e293b}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.btn{padding:10px 24px;border-radius:8px;border:none;font-weight:600;font-size:.9rem;transition:all .2s;cursor:pointer;font-family:inherit}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(59,130,246,.3)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary);background:rgba(59,130,246,.1)}
.btn-sm{padding:6px 16px;font-size:.82rem}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.9}

nav{display:flex;justify-content:space-between;align-items:center;padding:16px 40px;border-bottom:1px solid var(--border);background:rgba(10,14,26,.95)}
.logo{font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
.nav-user{display:flex;align-items:center;gap:10px}
.nav-user span{color:var(--muted);font-size:.9rem}

.container{max-width:1200px;margin:0 auto;padding:32px 40px}
h1{font-size:1.8rem;margin-bottom:8px}
.subtitle{color:var(--muted);margin-bottom:32px}

.actions-bar{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
.actions-bar input{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.9rem;width:200px}

.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px;margin-bottom:40px}
.game-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px;transition:all .3s;cursor:pointer}
.game-card:hover{border-color:var(--primary);box-shadow:0 4px 20px rgba(59,130,246,.08)}
.game-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:12px}
.game-name{font-size:1.1rem;font-weight:600}
.game-status{padding:4px 10px;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase}
.status-lobby{background:rgba(245,158,11,.15);color:var(--yellow)}
.status-active{background:rgba(16,185,129,.15);color:var(--green)}
.status-completed{background:rgba(148,163,184,.15);color:var(--muted)}
.game-meta{color:var(--muted);font-size:.85rem;display:flex;flex-direction:column;gap:6px}
.game-meta span{display:flex;align-items:center;gap:6px}
.game-footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)}
.team-badge{display:flex;align-items:center;gap:6px;font-size:.9rem}
.quarter-display{font-size:.85rem;color:var(--muted)}
.quarter-display strong{color:var(--primary);font-size:1rem}

.empty-state{text-align:center;padding:60px;color:var(--muted)}
.empty-state .icon{font-size:3rem;margin-bottom:16px}
.empty-state h3{color:var(--text);margin-bottom:8px}
.empty-state p{margin-bottom:20px}

/* Modals */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;width:480px;max-width:90vw}
.modal h2{font-size:1.3rem;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.9rem;font-family:inherit}
.form-group textarea{height:80px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.alert{padding:10px 14px;border-radius:8px;font-size:.85rem;margin-bottom:16px;display:none}
.alert-error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--red)}
.alert-success{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:var(--green)}

.section-title{font-size:1.2rem;font-weight:600;margin:32px 0 16px;display:flex;align-items:center;gap:8px}
</style>
</head>
<body>

<nav>
  <a href="/index.html" class="logo">üö¥ MarketSim Live</a>
  <div class="nav-user">
    <span id="userName"></span>
    <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container">
  <h1 id="greeting">Dashboard</h1>
  <p class="subtitle" id="roleLabel"></p>

  <div class="actions-bar">
    <button class="btn btn-primary" id="createGameBtn" onclick="showModal('createGame')" style="display:none">+ Create Game</button>
    <button class="btn btn-outline" onclick="showModal('joinGame')">üîó Join Game</button>
  </div>

  <div class="section-title">üìã My Games</div>
  <div id="gamesList" class="games-grid"></div>
  <div id="emptyState" class="empty-state" style="display:none">
    <div class="icon">üéÆ</div>
    <h3>No games yet</h3>
    <p>Create a new game or join one with a code from your instructor.</p>
  </div>
</div>

<!-- Create Game Modal -->
<div class="modal-overlay" id="createGameModal">
  <div class="modal">
    <h2>Create New Game</h2>
    <div class="alert alert-error" id="createError"></div>
    <div class="form-group"><label>Game Name</label><input type="text" id="cgName" placeholder="e.g. Spring 2026 Marketing"></div>
    <div class="form-row">
      <div class="form-group"><label>Max Teams</label><select id="cgMaxTeams"><option value="4">4 teams</option><option value="5">5 teams</option><option value="6" selected>6 teams</option><option value="8">8 teams</option></select></div>
      <div class="form-group"><label>Team Size</label><select id="cgTeamSize"><option value="3">3 members</option><option value="4" selected>4 members</option><option value="5">5 members</option></select></div>
    </div>
    <div class="form-group"><label>Market Scenario</label><select id="cgScenario"><option value="standard">Standard ‚Äî Carbon Fiber Bikes</option></select></div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
      <button class="btn btn-primary" onclick="doCreateGame()">Create Game</button>
    </div>
  </div>
</div>

<!-- Join Game Modal -->
<div class="modal-overlay" id="joinGameModal">
  <div class="modal">
    <h2>Join a Game</h2>
    <div class="alert alert-error" id="joinError"></div>
    <div class="alert alert-success" id="joinSuccess"></div>
    <div class="form-group"><label>Game Code</label><input type="text" id="joinCode" placeholder="e.g. MKT-ABC123" style="text-transform:uppercase"></div>
    <div class="form-group"><label>Team Name (optional ‚Äî leave blank to auto-assign)</label><input type="text" id="joinTeam" placeholder="e.g. Thunder Cycles"></div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
      <button class="btn btn-primary" onclick="doJoinGame()">Join</button>
    </div>
  </div>
</div>

<script>
const API=window.location.origin;
let user=null;

function showModal(id){closeModals();document.getElementById(id+'Modal').classList.add('active')}
function closeModals(){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'))}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeModals()}));

async function apiFetch(url,opts={}){
  const token=localStorage.getItem('token');
  const headers={'Content-Type':'application/json'};
  if(token)headers['Authorization']='Bearer '+token;
  const res=await fetch(API+url,{...opts,headers});
  return res.json();
}

function logout(){localStorage.removeItem('token');window.location.href='/index.html'}

async function init(){
  const data=await apiFetch('/api/auth/me');
  if(!data.user)return window.location.href='/index.html';
  user=data.user;
  document.getElementById('userName').textContent=user.name;
  document.getElementById('greeting').textContent=`Welcome, ${user.name.split(' ')[0]}!`;
  document.getElementById('roleLabel').textContent=user.is_instructor?'Instructor Account':'Student Account';
  if(user.is_instructor)document.getElementById('createGameBtn').style.display='';
  loadGames();
}

async function loadGames(){
  const data=await apiFetch('/api/game/list');
  const games=data.games||[];
  const container=document.getElementById('gamesList');
  if(!games.length){container.innerHTML='';document.getElementById('emptyState').style.display='';return}
  document.getElementById('emptyState').style.display='none';
  container.innerHTML=games.map(g=>{
    const statusClass=g.status==='lobby'?'status-lobby':g.status==='active'?'status-active':'status-completed';
    const qLabel=g.current_quarter===0?'Lobby':`Q${g.current_quarter}/8`;
    return `<div class="game-card" onclick="openGame('${g.id}')">
      <div class="game-header">
        <div class="game-name">${esc(g.name||'Game')}</div>
        <span class="game-status ${statusClass}">${g.status}</span>
      </div>
      <div class="game-meta">
        <span>üìå Code: <strong>${g.code}</strong></span>
        <span>üë• ${g.team_count||0} team${g.team_count!==1?'s':''}</span>
        ${g.team_name?`<span>üè∑Ô∏è My Team: ${esc(g.team_name)}</span>`:''}
      </div>
      <div class="game-footer">
        <div class="quarter-display">Quarter: <strong>${qLabel}</strong></div>
        ${g.role==='instructor'?'<span style="color:var(--accent);font-size:.8rem">üë®‚Äçüè´ Instructor</span>':'<span style="font-size:.8rem">üéÆ Player</span>'}
      </div>
    </div>`;
  }).join('');
}

function openGame(id){
  const game=(window._games||[]).find(g=>g.id===id);
  window.location.href='/simulation.html?game='+id;
}

async function doCreateGame(){
  const name=document.getElementById('cgName').value.trim();
  const max_teams=parseInt(document.getElementById('cgMaxTeams').value);
  const scenario=document.getElementById('cgScenario').value;
  if(!name){document.getElementById('createError').textContent='Please enter a game name';document.getElementById('createError').style.display='block';return}
  const data=await apiFetch('/api/game/create',{method:'POST',body:JSON.stringify({name,max_teams,market_scenario:scenario})});
  if(data.error){document.getElementById('createError').textContent=data.error;document.getElementById('createError').style.display='block';return}
  closeModals();
  loadGames();
}

async function doJoinGame(){
  const code=document.getElementById('joinCode').value.trim().toUpperCase();
  const team_name=document.getElementById('joinTeam').value.trim();
  if(!code){document.getElementById('joinError').textContent='Please enter a game code';document.getElementById('joinError').style.display='block';return}
  const data=await apiFetch('/api/game/join',{method:'POST',body:JSON.stringify({code,team_name:team_name||undefined})});
  if(data.error){document.getElementById('joinError').textContent=data.error;document.getElementById('joinError').style.display='block';return}
  document.getElementById('joinSuccess').textContent='Joined successfully!';document.getElementById('joinSuccess').style.display='block';
  setTimeout(()=>{closeModals();loadGames()},1000);
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

init();
</script>
</body>
</html>
