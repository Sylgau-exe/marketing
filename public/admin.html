<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äî MarketSim</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f8f9fc;--white:#fff;--sidebar:#0f0f1e;--sidebar-border:#1e1e35;--card:#fff;--border:#e5e7eb;--primary:#6366f1;--primary-light:#818cf8;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--cyan:#06b6d4;--text:#1e293b;--muted:#64748b;--dim:#94a3b8;--light:#f1f5f9}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}

/* Dark sidebar */
.sidebar{width:200px;background:var(--sidebar);border-right:1px solid var(--sidebar-border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50}
.sidebar-logo{padding:20px;font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:8px}
.sidebar-logo .brand{background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-nav{flex:1;padding:8px 12px}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:10px;color:#94a3b8;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .2s;margin-bottom:2px;text-decoration:none}
.nav-item:hover{background:rgba(99,102,241,.08);color:#e2e8f0}
.nav-item.active{background:rgba(99,102,241,.15);color:var(--primary-light);font-weight:600}
.nav-item .icon{font-size:1.05rem;width:22px;text-align:center}
.sidebar-footer{padding:16px;border-top:1px solid var(--sidebar-border)}
.sidebar-footer a{display:flex;align-items:center;gap:8px;color:#94a3b8;text-decoration:none;font-size:.85rem;padding:10px 14px;border-radius:10px;transition:all .2s}
.sidebar-footer a:hover{background:rgba(99,102,241,.08);color:#e2e8f0}

/* Main area - light */
.main{margin-left:200px;flex:1;min-height:100vh}

/* Top header */
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 32px;border-bottom:1px solid var(--border);background:var(--white);position:sticky;top:0;z-index:40}
.topbar-title{font-size:1.2rem;font-weight:700;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-right .admin-badge{font-size:.7rem;padding:3px 10px;background:rgba(99,102,241,.1);color:var(--primary);border-radius:20px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.topbar-right .user-name{color:var(--muted);font-size:.9rem}
.topbar-right button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.85rem;font-family:inherit;padding:6px 12px;border-radius:6px;transition:all .2s}
.topbar-right button:hover{color:var(--text);background:var(--light)}

/* Content */
.content{padding:28px 32px}
.welcome-msg{color:var(--muted);font-size:.92rem;margin-bottom:24px}

/* Stat cards - gradient on white bg */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:28px}
.stat-card{border-radius:16px;padding:22px 24px;color:#fff;position:relative;overflow:hidden;transition:transform .3s,box-shadow .3s;cursor:default}
.stat-card:hover{transform:translateY(-3px)}
.stat-card::before{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%);pointer-events:none}
.stat-card .stat-icon{width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;margin-bottom:14px}
.stat-card .stat-value{font-size:2rem;font-weight:700;margin-bottom:2px}
.stat-card .stat-label{font-size:.78rem;text-transform:uppercase;letter-spacing:.5px;opacity:.85;font-weight:600}
.stat-card .stat-badge{display:inline-flex;align-items:center;gap:3px;margin-top:10px;padding:3px 10px;background:rgba(255,255,255,.18);border-radius:20px;font-size:.72rem;font-weight:600}
.stat-card.users{background:linear-gradient(135deg,#667eea,#764ba2);box-shadow:0 8px 30px rgba(102,126,234,.2)}
.stat-card.revenue{background:linear-gradient(135deg,#f093fb,#f5576c);box-shadow:0 8px 30px rgba(245,87,108,.15)}
.stat-card.teams{background:linear-gradient(135deg,#43e97b,#38f9d7);box-shadow:0 8px 30px rgba(67,233,123,.12)}
.stat-card.teams .stat-value,.stat-card.teams .stat-label,.stat-card.teams .stat-badge{color:#0f172a}
.stat-card.active{background:linear-gradient(135deg,#4facfe,#00f2fe);box-shadow:0 8px 30px rgba(79,172,254,.15)}
.stat-card.active .stat-value,.stat-card.active .stat-label,.stat-card.active .stat-badge{color:#0f172a}

/* Secondary stats */
.stats-row2{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:28px}
.stat2{background:var(--white);border:1px solid var(--border);border-radius:14px;padding:22px 24px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.stat2 .stat2-label{font-size:.8rem;color:var(--muted);margin-bottom:6px}
.stat2 .stat2-value{font-size:1.8rem;font-weight:700;color:var(--text)}
.stat2 .stat2-sub{font-size:.78rem;color:var(--dim);margin-top:6px}
.stat2 .progress-bar{height:6px;background:var(--light);border-radius:3px;margin-top:10px;overflow:hidden}
.stat2 .progress-fill{height:100%;border-radius:3px;background:var(--primary);transition:width 1s ease}

/* Panels - white cards */
.panel{background:var(--white);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.panel-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:16px}
.panel-header h2{font-size:1.1rem;font-weight:700;color:var(--text)}
.panel-header .controls{display:flex;gap:10px;align-items:center}
.search-input{padding:8px 14px;background:var(--light);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.85rem;font-family:inherit;outline:none;transition:border-color .2s;width:220px}
.search-input:focus{border-color:var(--primary)}
.search-input::placeholder{color:var(--dim)}
.filter-select{padding:8px 12px;background:var(--light);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.85rem;font-family:inherit;outline:none}

/* Tables - light */
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:2px solid var(--border)}
th{text-align:left;padding:12px 20px;color:var(--muted);font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;font-weight:600;background:var(--light)}
td{padding:14px 20px;border-bottom:1px solid var(--border);font-size:.88rem}
tbody tr:hover{background:var(--light)}
.user-cell{display:flex;align-items:center;gap:12px}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-size:.82rem;font-weight:700;flex-shrink:0}
.user-name-text{font-weight:600;font-size:.88rem;display:flex;align-items:center;gap:6px}
.user-email{color:var(--dim);font-size:.78rem}

/* Badges */
.badge{display:inline-flex;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600}
.badge-admin{background:rgba(245,158,11,.12);color:#b45309}
.badge-free{background:#f1f5f9;color:var(--muted)}
.badge-pro{background:rgba(99,102,241,.1);color:var(--primary)}
.badge-lifetime{background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(99,102,241,.12));color:#7c3aed}
.badge-email{background:var(--light);color:var(--muted)}
.badge-google{background:rgba(59,130,246,.08);color:#2563eb}
.badge-lobby{background:rgba(245,158,11,.08);color:#b45309}
.badge-active{background:rgba(16,185,129,.08);color:#059669}
.badge-completed{background:var(--light);color:var(--muted)}
.table-footer{padding:12px 20px;border-top:1px solid var(--border);font-size:.82rem;color:var(--dim)}

/* Action buttons */
.action-btn{padding:5px 14px;border:none;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.action-btn.edit{background:rgba(99,102,241,.08);color:var(--primary)}
.action-btn.edit:hover{background:rgba(99,102,241,.15)}
.action-btn.delete{background:rgba(239,68,68,.06);color:var(--red)}
.action-btn.delete:hover{background:rgba(239,68,68,.12)}

/* Activity feed */
.activity-item{display:flex;align-items:flex-start;gap:14px;padding:16px 24px;border-bottom:1px solid var(--border);transition:background .15s}
.activity-item:last-child{border-bottom:none}
.activity-item:hover{background:var(--light)}
.activity-icon{width:36px;height:36px;border-radius:10px;background:var(--light);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.activity-text{font-size:.88rem;color:var(--muted);line-height:1.4}
.activity-text strong{color:var(--text)}
.activity-time{font-size:.75rem;color:var(--dim);margin-top:3px}

/* Two column */
.two-col{display:grid;grid-template-columns:1.5fr 1fr;gap:24px}

/* Pages */
.page{display:none}
.page.active{display:block}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:480px;width:100%;position:relative;box-shadow:0 25px 50px rgba(0,0,0,.15)}
.modal h3{font-size:1.2rem;font-weight:700;margin-bottom:20px;color:var(--text)}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem;padding:4px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.82rem;color:var(--muted);margin-bottom:6px;font-weight:500}
.form-group input{width:100%;padding:10px 14px;background:var(--light);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.9rem;font-family:inherit;outline:none;transition:border-color .2s}
.form-group input:focus{border-color:var(--primary)}
.form-check{display:flex;align-items:center;gap:10px;margin:16px 0}
.form-check input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary)}
.form-check label{font-size:.9rem;color:var(--text)}
.btn{padding:10px 24px;border-radius:10px;border:none;font-weight:600;font-size:.9rem;cursor:pointer;font-family:inherit;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(99,102,241,.3)}
.btn-primary:disabled{opacity:.5;transform:none;cursor:not-allowed}
.form-error{color:var(--red);font-size:.82rem;margin-top:10px;display:none}

/* Loading */
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton{background:linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 50%,#f1f5f9 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:12px}
.skel-stat{height:120px}
.skel-row{height:56px;margin-bottom:4px}

/* Row animation */
@keyframes slideIn{from{opacity:0;transform:translateX(-15px)}to{opacity:1;transform:translateX(0)}}
tbody tr{animation:slideIn .3s ease forwards;opacity:0}
tbody tr:nth-child(1){animation-delay:.03s}tbody tr:nth-child(2){animation-delay:.06s}tbody tr:nth-child(3){animation-delay:.09s}tbody tr:nth-child(4){animation-delay:.12s}tbody tr:nth-child(5){animation-delay:.15s}tbody tr:nth-child(6){animation-delay:.18s}tbody tr:nth-child(7){animation-delay:.21s}tbody tr:nth-child(8){animation-delay:.24s}

@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:countUp .5s ease forwards}

@media(max-width:1024px){.stats-grid{grid-template-columns:repeat(2,1fr)}.stats-row2{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}}
</style>
</head>
<body>

<!-- Sidebar (dark) -->
<aside class="sidebar">
  <div class="sidebar-logo"><span style="font-size:1.3rem">üéØ</span><span class="brand">MarketSim</span></div>
  <nav class="sidebar-nav">
    <a class="nav-item active" data-page="overview"><span class="icon">üìä</span>Overview</a>
    <a class="nav-item" data-page="users"><span class="icon">üë•</span>Users</a>
    <a class="nav-item" data-page="games"><span class="icon">üéÆ</span>Simulations</a>
    <a class="nav-item" data-page="revenue"><span class="icon">üí∞</span>Revenue</a>
    <a class="nav-item" data-page="activity"><span class="icon">üìã</span>Activity</a>
  </nav>
  <div class="sidebar-footer">
    <a href="/dashboard.html">‚Üê Back to App</a>
  </div>
</aside>

<!-- Main (light) -->
<div class="main">
  <header class="topbar">
    <div class="topbar-title" id="pageTitle">Overview</div>
    <div class="topbar-right">
      <span class="admin-badge">Admin</span>
      <span class="user-name" id="headerUser"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="content">
    <!-- Loading -->
    <div id="loadingState">
      <div class="stats-grid"><div class="skeleton skel-stat"></div><div class="skeleton skel-stat"></div><div class="skeleton skel-stat"></div><div class="skeleton skel-stat"></div></div>
      <div class="skeleton skel-row"></div><div class="skeleton skel-row"></div><div class="skeleton skel-row"></div>
    </div>

    <!-- OVERVIEW -->
    <div class="page" id="page-overview">
      <p class="welcome-msg">Welcome! Here's what's happening with MarketSim today.</p>
      <div class="stats-grid">
        <div class="stat-card users"><div class="stat-icon">üë•</div><div class="stat-value animate-in" id="sUsers">0</div><div class="stat-label">Total Users</div><div class="stat-badge" id="sUsers7d">+0 this week</div></div>
        <div class="stat-card revenue"><div class="stat-icon">üí∞</div><div class="stat-value animate-in" id="sRevenue">$0</div><div class="stat-label">Monthly Revenue</div><div class="stat-badge" id="sRevBadge">MRR</div></div>
        <div class="stat-card teams"><div class="stat-icon">üèÜ</div><div class="stat-value animate-in" id="sTeams">0</div><div class="stat-label">Teams Created</div><div class="stat-badge" id="sDecisions">0 decisions</div></div>
        <div class="stat-card active"><div class="stat-icon">‚ö°</div><div class="stat-value animate-in" id="sActive">0</div><div class="stat-label">Active Now</div><div class="stat-badge">Live</div></div>
      </div>

      <div class="stats-row2">
        <div class="stat2"><div class="stat2-label">Active Users (30d)</div><div class="stat2-value" id="s30dActive">0</div><div class="stat2-sub" id="s30dPct">0% of total users</div><div class="progress-bar"><div class="progress-fill" id="s30dBar" style="width:0%"></div></div></div>
        <div class="stat2"><div class="stat2-label">Avg Session Progress</div><div class="stat2-value" id="sAvgQ">Q0</div><div class="stat2-sub">Average quarter across active games</div></div>
        <div class="stat2"><div class="stat2-label">Scenario Popularity</div><div class="stat2-value" id="sTopScenario">‚Äî</div><div class="stat2-sub" id="sScenarioSub">Most played scenario</div></div>
      </div>

      <div class="two-col">
        <div class="panel"><div class="panel-header"><h2>Recent Activity</h2></div><div id="activityList" style="padding:4px 0"><div style="padding:20px;color:var(--dim)">Loading...</div></div></div>
        <div class="panel"><div class="panel-header"><h2>Recent Simulations</h2></div><div id="recentGamesList"><div style="padding:20px;color:var(--dim)">Loading...</div></div></div>
      </div>
    </div>

    <!-- USERS -->
    <div class="page" id="page-users">
      <div class="panel">
        <div class="panel-header">
          <h2>Users</h2>
          <div class="controls">
            <input type="text" class="search-input" id="userSearch" placeholder="Search users..." oninput="filterUsers()">
            <select class="filter-select" id="userPlanFilter" onchange="filterUsers()">
              <option value="">All Plans</option>
              <option value="free">Free</option>
              <option value="pro-monthly">Pro Monthly</option>
              <option value="pro-lifetime">Pro Lifetime</option>
            </select>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table><thead><tr><th>User</th><th>Plan</th><th>Provider</th><th>Games</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="usersBody"></tbody></table>
        </div>
        <div class="table-footer" id="userCount">Loading users...</div>
      </div>
    </div>

    <!-- GAMES -->
    <div class="page" id="page-games">
      <div class="panel">
        <div class="panel-header">
          <h2>All Simulations</h2>
          <div class="controls">
            <select class="filter-select" id="gameFilter" onchange="filterGames()">
              <option value="">All Status</option><option value="lobby">Lobby</option><option value="active">Active</option><option value="completed">Completed</option>
            </select>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table><thead><tr><th>Simulation</th><th>Scenario</th><th>Status</th><th>Quarter</th><th>Teams</th><th>Created</th></tr></thead><tbody id="gamesBody"></tbody></table>
        </div>
        <div class="table-footer" id="gameCount">Loading games...</div>
      </div>
    </div>

    <!-- REVENUE -->
    <div class="page" id="page-revenue">
      <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
        <div class="stat-card users"><div class="stat-icon">üíµ</div><div class="stat-value" id="rMRR">$0</div><div class="stat-label">Monthly Revenue</div><div class="stat-badge">MRR</div></div>
        <div class="stat-card revenue"><div class="stat-icon">üëë</div><div class="stat-value" id="rPro">0</div><div class="stat-label">Pro Users</div><div class="stat-badge" id="rProPct">0%</div></div>
        <div class="stat-card teams"><div class="stat-icon">‚ôæÔ∏è</div><div class="stat-value" id="rLifetime">0</div><div class="stat-label">Lifetime Users</div><div class="stat-badge" id="rLifeRevenue">$0 total</div></div>
      </div>
      <div class="panel">
        <div class="panel-header"><h2>User Plans Breakdown</h2></div>
        <div style="overflow-x:auto">
          <table><thead><tr><th>Plan</th><th>Count</th><th>% of Users</th><th>Revenue</th></tr></thead><tbody id="revenueBody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- ACTIVITY -->
    <div class="page" id="page-activity">
      <div class="panel"><div class="panel-header"><h2>All Activity</h2></div><div id="fullActivityList"><div style="padding:20px;color:var(--dim)">Loading...</div></div></div>
    </div>

  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay" style="display:none">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <h3>Edit User</h3>
    <input type="hidden" id="editId">
    <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
    <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
    <div class="form-group"><label>Organization</label><input type="text" id="editOrg"></div>
    <div class="form-check"><input type="checkbox" id="editAdmin"><label for="editAdmin">Admin privileges</label></div>
    <div class="form-error" id="editError"></div>
    <button class="btn btn-primary" id="editSaveBtn" onclick="saveUser()">Save Changes</button>
  </div>
</div>

<script>
const API=window.location.origin;
let allUsers=[],allGames=[];
function headers(){const h={'Content-Type':'application/json'};const t=localStorage.getItem('token');if(t)h['Authorization']='Bearer '+t;return h}
function logout(){localStorage.removeItem('token');location.href='/index.html'}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function timeAgo(d){const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+' min ago';if(s<86400)return Math.floor(s/3600)+' hours ago';if(s<604800)return Math.floor(s/86400)+' days ago';return new Date(d).toLocaleDateString()}

const SCENARIO_NAMES={'local-launch':'üì± Phone First','mountain-expedition':'‚åö Wearable Edge','global-domination':'üíª Laptop Empire','speed-innovation':'ü•Ω VR Rush'};

// Nav
document.querySelectorAll('.nav-item[data-page]').forEach(item=>{
  item.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('page-'+item.dataset.page).classList.add('active');
    document.getElementById('pageTitle').textContent=item.textContent.trim();
  });
});

function animateCounter(id,target,prefix,suffix){
  const el=document.getElementById(id);if(!el||!target||isNaN(target)){el.textContent=(prefix||'')+'0'+(suffix||'');return}
  const duration=900,start=performance.now();
  function tick(now){const p=Math.min((now-start)/duration,1);const eased=1-Math.pow(1-p,4);el.textContent=(prefix||'')+Math.floor(eased*target).toLocaleString()+(suffix||'');if(p<1)requestAnimationFrame(tick)}
  requestAnimationFrame(tick);
}

function getPlanBadge(u){
  if(u.plan==='pro'&&u.planType==='lifetime')return'<span class="badge badge-lifetime">üëë Lifetime</span>';
  if(u.plan==='pro')return'<span class="badge badge-pro">üíé Pro Monthly</span>';
  return'<span class="badge badge-free">Free</span>';
}

async function init(){
  const authRes=await fetch(API+'/api/auth/me',{headers:headers()});
  const auth=await authRes.json();
  if(!auth.user||!auth.user.isAdmin){
    document.getElementById('loadingState').innerHTML='<div style="text-align:center;padding:80px"><div style="font-size:4rem;margin-bottom:16px">üîí</div><h2 style="margin-bottom:8px">Admin Access Required</h2><p style="color:var(--muted)">You don\'t have permission to view this page.</p><a href="/dashboard.html" style="color:var(--primary);margin-top:16px;display:inline-block">‚Üê Back to Dashboard</a></div>';
    return;
  }
  document.getElementById('headerUser').textContent=auth.user.name;

  const [statsRes,usersRes]=await Promise.all([
    fetch(API+'/api/admin/stats',{headers:headers()}).then(r=>r.json()),
    fetch(API+'/api/admin/users',{headers:headers()}).then(r=>r.json())
  ]);

  document.getElementById('loadingState').style.display='none';
  document.getElementById('page-overview').classList.add('active');

  const s=statsRes.stats||{};
  animateCounter('sUsers',s.total_users);
  animateCounter('sTeams',s.total_teams);
  animateCounter('sActive',(statsRes.last30Days||{}).activeUsers||0);
  document.getElementById('sUsers7d').textContent='+'+(((statsRes.last7Days||{}).newUsers)||0)+' this week';
  document.getElementById('sDecisions').textContent=s.total_decisions+' decisions';

  // Revenue from users
  allUsers=usersRes.users||[];
  const proMonthly=allUsers.filter(u=>u.plan==='pro'&&u.planType!=='lifetime');
  const proLifetime=allUsers.filter(u=>u.plan==='pro'&&u.planType==='lifetime');
  const freeUsers=allUsers.filter(u=>u.plan!=='pro');
  const mrr=proMonthly.length*19;

  document.getElementById('sRevenue').textContent='$'+mrr;
  document.getElementById('sRevBadge').textContent=proMonthly.length+' subscribers';

  // Revenue page
  document.getElementById('rMRR').textContent='$'+mrr;
  animateCounter('rPro',proMonthly.length);
  animateCounter('rLifetime',proLifetime.length);
  document.getElementById('rProPct').textContent=allUsers.length?Math.round((proMonthly.length+proLifetime.length)/allUsers.length*100)+'% paid':'0%';
  document.getElementById('rLifeRevenue').textContent='$'+(proLifetime.length*149)+' total';

  document.getElementById('revenueBody').innerHTML=
    '<tr style="animation-delay:.03s"><td><span class="badge badge-free">Free</span></td><td>'+freeUsers.length+'</td><td>'+(allUsers.length?Math.round(freeUsers.length/allUsers.length*100):0)+'%</td><td>$0</td></tr>'+
    '<tr style="animation-delay:.06s"><td><span class="badge badge-pro">üíé Pro Monthly</span></td><td>'+proMonthly.length+'</td><td>'+(allUsers.length?Math.round(proMonthly.length/allUsers.length*100):0)+'%</td><td>$'+mrr+'/mo</td></tr>'+
    '<tr style="animation-delay:.09s"><td><span class="badge badge-lifetime">üëë Lifetime</span></td><td>'+proLifetime.length+'</td><td>'+(allUsers.length?Math.round(proLifetime.length/allUsers.length*100):0)+'%</td><td>$'+(proLifetime.length*149)+' (one-time)</td></tr>';

  // Overview stats
  const active30=(statsRes.last30Days||{}).activeUsers||0;
  const totalU=s.total_users||1;
  document.getElementById('s30dActive').textContent=active30;
  const pct=Math.round(active30/totalU*100);
  document.getElementById('s30dPct').textContent=pct+'% of total users';
  document.getElementById('s30dBar').style.width=pct+'%';
  document.getElementById('sAvgQ').textContent=s.avg_quarter?'Q'+s.avg_quarter:'Q0';

  const scenarios=statsRes.scenarioDistribution||[];
  if(scenarios.length>0){document.getElementById('sTopScenario').textContent=SCENARIO_NAMES[scenarios[0].market_scenario]||scenarios[0].market_scenario;document.getElementById('sScenarioSub').textContent=scenarios[0].count+' games played';}

  // Activity
  const activity=statsRes.recentActivity||[];
  const actHtml=activity.length?activity.map(a=>'<div class="activity-item"><div class="activity-icon">'+a.icon+'</div><div><div class="activity-text">'+esc(a.text)+'</div><div class="activity-time">'+timeAgo(a.time)+'</div></div></div>').join(''):'<div style="padding:24px;color:var(--dim);text-align:center">No activity yet</div>';
  document.getElementById('activityList').innerHTML=actHtml;
  document.getElementById('fullActivityList').innerHTML=actHtml;

  // Recent games
  allGames=statsRes.recentGames||[];
  const gamesHtml=allGames.length?allGames.slice(0,5).map(g=>'<div class="activity-item"><div class="activity-icon">üéÆ</div><div><div class="activity-text"><strong>'+esc(g.name||'Game')+'</strong> ‚Äî '+(SCENARIO_NAMES[g.scenario]||g.scenario)+'</div><div class="activity-time">'+(g.status==='active'?'üü¢ Active':'‚è≥ '+g.status)+' ¬∑ Q'+g.quarter+' ¬∑ '+g.teams+' teams ¬∑ '+timeAgo(g.created)+'</div></div></div>').join(''):'<div style="padding:24px;color:var(--dim);text-align:center">No simulations yet</div>';
  document.getElementById('recentGamesList').innerHTML=gamesHtml;

  renderUsers(allUsers);
  renderGames(allGames);
}

function renderUsers(users){
  document.getElementById('usersBody').innerHTML=users.map((u,i)=>
    '<tr style="animation-delay:'+(i*0.03)+'s">'+
      '<td><div class="user-cell"><div class="user-avatar">'+(u.name?u.name.charAt(0).toUpperCase():'?')+'</div><div><div class="user-name-text">'+esc(u.name||'Unknown')+(u.isAdmin?' <span class="badge badge-admin">Admin</span>':'')+'</div><div class="user-email">'+esc(u.email)+'</div></div></div></td>'+
      '<td>'+getPlanBadge(u)+'</td>'+
      '<td><span class="badge '+(u.authProvider==='google'?'badge-google':'badge-email')+'">'+(u.authProvider==='google'?'üîµ Google':'‚úâÔ∏è Email')+'</span></td>'+
      '<td>'+u.games+'</td>'+
      '<td style="color:var(--muted)">'+u.joined+'</td>'+
      '<td><div style="display:flex;gap:6px"><button class="action-btn edit" onclick=\'openEdit('+JSON.stringify(u).replace(/'/g,"&#39;")+')\'">Edit</button><button class="action-btn delete" onclick="deleteUser('+u.id+',\''+esc(u.email)+'\')">Delete</button></div></td>'+
    '</tr>'
  ).join('');
  document.getElementById('userCount').textContent='Showing '+users.length+' of '+allUsers.length+' users';
}

function filterUsers(){
  const q=document.getElementById('userSearch').value.toLowerCase();
  const pf=document.getElementById('userPlanFilter').value;
  const filtered=allUsers.filter(u=>{
    const matchQ=!q||(u.name||'').toLowerCase().includes(q)||u.email.toLowerCase().includes(q);
    let matchP=true;
    if(pf==='free')matchP=u.plan!=='pro';
    if(pf==='pro-monthly')matchP=u.plan==='pro'&&u.planType!=='lifetime';
    if(pf==='pro-lifetime')matchP=u.plan==='pro'&&u.planType==='lifetime';
    return matchQ&&matchP;
  });
  renderUsers(filtered);
}

function renderGames(games){
  document.getElementById('gamesBody').innerHTML=games.map((g,i)=>
    '<tr style="animation-delay:'+(i*0.03)+'s">'+
      '<td><strong>'+esc(g.name||'Game')+'</strong></td>'+
      '<td>'+(SCENARIO_NAMES[g.scenario]||g.scenario||'‚Äî')+'</td>'+
      '<td><span class="badge badge-'+g.status+'">'+g.status+'</span></td>'+
      '<td>Q'+g.quarter+'/8</td>'+
      '<td>'+g.teams+'</td>'+
      '<td style="color:var(--muted)">'+timeAgo(g.created)+'</td>'+
    '</tr>'
  ).join('');
  document.getElementById('gameCount').textContent='Showing '+games.length+' simulations';
}
function filterGames(){const st=document.getElementById('gameFilter').value;renderGames(st?allGames.filter(g=>g.status===st):allGames);}

function openEdit(user){
  document.getElementById('editId').value=user.id;
  document.getElementById('editName').value=user.name||'';
  document.getElementById('editEmail').value=user.email||'';
  document.getElementById('editOrg').value=(user.organization&&user.organization!=='-')?user.organization:'';
  document.getElementById('editAdmin').checked=user.isAdmin;
  document.getElementById('editError').style.display='none';
  document.getElementById('editModal').style.display='flex';
}
function closeModal(){document.getElementById('editModal').style.display='none';}

async function saveUser(){
  const btn=document.getElementById('editSaveBtn'),err=document.getElementById('editError');
  btn.disabled=true;btn.textContent='Saving...';err.style.display='none';
  try{
    const res=await fetch(API+'/api/admin/edit-user',{method:'POST',headers:headers(),body:JSON.stringify({userId:parseInt(document.getElementById('editId').value),name:document.getElementById('editName').value,email:document.getElementById('editEmail').value,organization:document.getElementById('editOrg').value,isAdmin:document.getElementById('editAdmin').checked})});
    const data=await res.json();if(!res.ok)throw new Error(data.error);
    closeModal();const usersRes=await fetch(API+'/api/admin/users',{headers:headers()}).then(r=>r.json());allUsers=usersRes.users||[];renderUsers(allUsers);
  }catch(e){err.textContent=e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Save Changes';}
}

async function deleteUser(userId,email){
  if(!confirm('Delete '+email+'? This removes all their game data and cannot be undone.'))return;
  try{const res=await fetch(API+'/api/admin/delete-user',{method:'DELETE',headers:headers(),body:JSON.stringify({userId})});if(!res.ok){const d=await res.json();throw new Error(d.error);}location.reload();}catch(e){alert('Error: '+e.message);}
}

init();
</script>
</body>
</html>
